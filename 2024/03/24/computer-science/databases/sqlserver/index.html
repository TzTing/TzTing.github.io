<!-- build time:Tue Apr 23 2024 00:46:46 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/tzblog/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/tzblog/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="一些记录" href="https://mytingting.gitee.io/tzblog/rss.xml"><link rel="alternate" type="application/atom+xml" title="一些记录" href="https://mytingting.gitee.io/tzblog/atom.xml"><link rel="alternate" type="application/json" title="一些记录" href="https://mytingting.gitee.io/tzblog/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/tzblog/css/app.css?v=0.2.5"><meta name="keywords" content="sqlserver"><link rel="canonical" href="https://mytingting.gitee.io/tzblog/2024/03/24/computer-science/databases/sqlserver/"><title>sqlserver数据库 - 数据库 - 计算机科学 | Tz = 一些记录 = = 编程、羽毛球、游戏、骑行 =</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">sqlserver数据库</h1><div class="meta"><span class="item" title="创建时间：2024-03-24 19:12:45"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-03-24T19:12:45+08:00">2024-03-24</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>34k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>31 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/tzblog/" rel="start">Tz</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tzting.github.io/images/sky8.jpg"></li><li class="item" data-background-image="https://tzting.github.io/images/sky10.jpg"></li><li class="item" data-background-image="https://tzting.github.io/images/sky2.jpg"></li><li class="item" data-background-image="https://tzting.github.io/images/sky7.jpg"></li><li class="item" data-background-image="https://tzting.github.io/images/sky5.jpg"></li><li class="item" data-background-image="https://tzting.github.io/images/sky1.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/tzblog/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/tzblog/categories/computer-science/" itemprop="item" rel="index" title="分类于 计算机科学"><span itemprop="name">计算机科学</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/tzblog/categories/computer-science/databases/" itemprop="item" rel="index" title="分类于 数据库"><span itemprop="name">数据库</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://mytingting.gitee.io/tzblog/2024/03/24/computer-science/databases/sqlserver/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/tzblog/images/avatar.jpg"><meta itemprop="name" content="Tz"><meta itemprop="description" content="= 编程、羽毛球、游戏、骑行 =, 君将自由, 我心亦然"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="一些记录"></span><div class="body md" itemprop="articleBody"><div class="note info"><p>可以通过一下关键字搜索相关内容：系统、性能、堵塞、表、数据库相关信息、事务锁、远程</p></div><h1 id="sqlserver数据库"><a class="anchor" href="#sqlserver数据库">#</a> sqlserver 数据库</h1><h2 id="简介"><a class="anchor" href="#简介">#</a> 简介</h2><p>sqlserver 数据库</p><h2 id="sqlserver常用脚本"><a class="anchor" href="#sqlserver常用脚本">#</a> sqlserver 常用脚本</h2><ol><li>sql server 开启 clr 权限：（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">exec</span> sp_configure <span class="token string">'clr enabled'</span><span class="token punctuation">,</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre>GO</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">RECONFIGURE</span></pre></td></tr><tr><td data-num="4"></td><td><pre>GO</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> HWMESTC <span class="token keyword">SET</span> TRUSTWORTHY <span class="token keyword">ON</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">AUTHORIZATION</span> <span class="token keyword">ON</span> <span class="token keyword">Database</span>::HWMESTC <span class="token keyword">TO</span> sa<span class="token punctuation">;</span></pre></td></tr></table></figure><ol start="2"><li>查询数据库大小（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">Exec</span> sp_spaceused</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">select</span> name<span class="token punctuation">,</span> <span class="token keyword">convert</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">,</span>size<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">8192.0</span><span class="token operator">/</span><span class="token number">1024.0</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024.</span> <span class="token keyword">from</span> dbo<span class="token punctuation">.</span>sysfiles</pre></td></tr></table></figure><ol start="3"><li>数据库日志压缩（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 选择需要使用的数据库</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">USE</span> PIMS</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 将数据库模式设置为 SIMPLE</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> PIMS <span class="token keyword">SET</span> RECOVERY <span class="token keyword">SIMPLE</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 将日志文件收缩到 1M </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">DBCC</span> SHRINKFILE <span class="token punctuation">(</span><span class="token string">'PIMS_log'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">-- 还原数据库</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> PIMS <span class="token keyword">SET</span> RECOVERY <span class="token keyword">FULL</span></pre></td></tr></table></figure><ol start="4"><li>查看数据库连接用户 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">top</span> <span class="token number">10</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">(</span>total_elapsed_time <span class="token operator">/</span> execution_count<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span> N<span class="token string">'平均时间ms'</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">,</span>total_elapsed_time<span class="token operator">/</span><span class="token number">1000</span> N<span class="token string">'总花费时间ms'</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">,</span>total_worker_time<span class="token operator">/</span><span class="token number">1000</span> N<span class="token string">'所用的CPU总时间ms'</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">,</span>total_physical_reads N<span class="token string">'物理读取总次数'</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">,</span>total_logical_reads<span class="token operator">/</span>execution_count N<span class="token string">'每次逻辑读次数'</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">,</span>total_logical_reads N<span class="token string">'逻辑读取总次数'</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">,</span>total_logical_writes N<span class="token string">'逻辑写入总次数'</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">,</span>execution_count N<span class="token string">'执行次数'</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">,</span>creation_time N<span class="token string">'语句编译时间'</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">,</span>last_execution_time N<span class="token string">'上次执行时间'</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">,</span>SUBSTRING<span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>        st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">(</span>qs<span class="token punctuation">.</span>statement_start_offset<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token punctuation">(</span><span class="token keyword">CASE</span> statement_end_offset <span class="token keyword">WHEN</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">THEN</span> DATALENGTH<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> qs<span class="token punctuation">.</span>statement_end_offset <span class="token keyword">END</span> <span class="token operator">-</span> qs<span class="token punctuation">.</span>statement_start_offset<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">)</span> N<span class="token string">'执行语句'</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">,</span>qp<span class="token punctuation">.</span>query_plan  </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">FROM</span>  sys<span class="token punctuation">.</span>dm_exec_query_stats <span class="token keyword">AS</span> qs </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> st </pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_query_plan<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>plan_handle<span class="token punctuation">)</span> qp  </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">WHERE</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre>    SUBSTRING<span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>        st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">(</span>qs<span class="token punctuation">.</span>statement_start_offset<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">(</span><span class="token keyword">CASE</span> statement_end_offset <span class="token keyword">WHEN</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">THEN</span> DATALENGTH<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> qs<span class="token punctuation">.</span>statement_end_offset <span class="token keyword">END</span> <span class="token operator">-</span> qs<span class="token punctuation">.</span>statement_start_offset<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token operator">like</span> <span class="token string">'%fetch%'</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span>  total_elapsed_time <span class="token operator">/</span> execution_count <span class="token keyword">DESC</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ol start="5"><li>查看执行时间最长的 sql (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">top</span> <span class="token number">10</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">(</span>total_elapsed_time <span class="token operator">/</span> execution_count<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span> N<span class="token string">'平均时间ms'</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">,</span>total_elapsed_time<span class="token operator">/</span><span class="token number">1000</span> N<span class="token string">'总花费时间ms'</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">,</span>total_worker_time<span class="token operator">/</span><span class="token number">1000</span> N<span class="token string">'所用的CPU总时间ms'</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">,</span>total_physical_reads N<span class="token string">'物理读取总次数'</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">,</span>total_logical_reads<span class="token operator">/</span>execution_count N<span class="token string">'每次逻辑读次数'</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">,</span>total_logical_reads N<span class="token string">'逻辑读取总次数'</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">,</span>total_logical_writes N<span class="token string">'逻辑写入总次数'</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">,</span>execution_count N<span class="token string">'执行次数'</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">,</span>creation_time N<span class="token string">'语句编译时间'</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">,</span>last_execution_time N<span class="token string">'上次执行时间'</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">,</span>SUBSTRING<span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>        st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">(</span>qs<span class="token punctuation">.</span>statement_start_offset<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token punctuation">(</span><span class="token keyword">CASE</span> statement_end_offset <span class="token keyword">WHEN</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">THEN</span> DATALENGTH<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> qs<span class="token punctuation">.</span>statement_end_offset <span class="token keyword">END</span> <span class="token operator">-</span> qs<span class="token punctuation">.</span>statement_start_offset<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>  </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">)</span> N<span class="token string">'执行语句'</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">,</span>qp<span class="token punctuation">.</span>query_plan  </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">FROM</span>  sys<span class="token punctuation">.</span>dm_exec_query_stats <span class="token keyword">AS</span> qs </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> st </pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_query_plan<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>plan_handle<span class="token punctuation">)</span> qp  </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">WHERE</span>  </pre></td></tr><tr><td data-num="24"></td><td><pre>    SUBSTRING<span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>        st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">(</span>qs<span class="token punctuation">.</span>statement_start_offset<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">(</span><span class="token keyword">CASE</span> statement_end_offset <span class="token keyword">WHEN</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">THEN</span> DATALENGTH<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> qs<span class="token punctuation">.</span>statement_end_offset <span class="token keyword">END</span> <span class="token operator">-</span> qs<span class="token punctuation">.</span>statement_start_offset<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>  </pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token operator">like</span> <span class="token string">'%fetch%'</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span>  total_elapsed_time <span class="token operator">/</span> execution_count <span class="token keyword">DESC</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ol start="6"><li>查看缓存中重用次数少，占用内存大的查询语句（当前缓存中未释放的）-- 全局（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">100</span> usecounts<span class="token punctuation">,</span> objtype<span class="token punctuation">,</span> p<span class="token punctuation">.</span>size_in_bytes<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token keyword">sql</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token keyword">text</span><span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_cached_plans p <span class="token keyword">OUTER</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text <span class="token punctuation">(</span>p<span class="token punctuation">.</span>plan_handle<span class="token punctuation">)</span> <span class="token keyword">sql</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> usecounts<span class="token punctuation">,</span>p<span class="token punctuation">.</span>size_in_bytes  <span class="token keyword">desc</span></pre></td></tr></table></figure><ol start="7"><li>看 BUFFER POOL 中，都缓存了哪些表 (当前数据库) 的数据（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> OBJECT_NAME<span class="token punctuation">(</span>object_id<span class="token punctuation">)</span> 表名<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> 页数<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">1024.0</span> Mb                              </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span>   sys<span class="token punctuation">.</span>dm_os_buffer_descriptors a<span class="token punctuation">,</span>sys<span class="token punctuation">.</span>allocation_units b<span class="token punctuation">,</span>sys<span class="token punctuation">.</span>partitions c                              </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">where</span>  a<span class="token punctuation">.</span>allocation_unit_id<span class="token operator">=</span>b<span class="token punctuation">.</span>allocation_unit_id   </pre></td></tr><tr><td data-num="4"></td><td><pre>       <span class="token operator">and</span> b<span class="token punctuation">.</span>container_id<span class="token operator">=</span>c<span class="token punctuation">.</span>hobt_id             </pre></td></tr><tr><td data-num="5"></td><td><pre>       <span class="token operator">and</span> database_id<span class="token operator">=</span>DB_ID<span class="token punctuation">(</span><span class="token punctuation">)</span>                              </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">group</span> <span class="token keyword">by</span> OBJECT_NAME<span class="token punctuation">(</span>object_id<span class="token punctuation">)</span>                           </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">2</span> <span class="token keyword">desc</span></pre></td></tr></table></figure><ol start="8"><li>查询 SQLSERVER 内存使用情况（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>dm_os_process_memory</pre></td></tr></table></figure><ol start="9"><li>查询 SqlServer 总体的内存使用情况（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span>      <span class="token keyword">type</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sum</span><span class="token punctuation">(</span>virtual_memory_reserved_kb<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.1</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">as</span> vm_Reserved_gb<span class="token punctuation">,</span><span class="token comment">-- 保留的内存  </span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">sum</span><span class="token punctuation">(</span>virtual_memory_committed_kb<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.1</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">as</span> vm_Committed_gb<span class="token punctuation">,</span><span class="token comment">-- 提交的内存  </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">sum</span><span class="token punctuation">(</span>awe_allocated_kb<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.1</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">as</span> awe_Allocated_gb<span class="token punctuation">,</span><span class="token comment">-- 开启 AWE 后使用的内存  </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">sum</span><span class="token punctuation">(</span>shared_memory_reserved_kb<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.1</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">as</span> sm_Reserved_gb<span class="token punctuation">,</span><span class="token comment">-- 共享的保留内存  </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">sum</span><span class="token punctuation">(</span>shared_memory_committed_kb<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.1</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">as</span> sm_Committed_gb<span class="token comment">-- 共享的提交内存  </span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">from</span>    sys<span class="token punctuation">.</span>dm_os_memory_clerks</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">type</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">type</span></pre></td></tr></table></figure><ol start="10"><li>查询当前数据库缓存的所有数据页面，哪些数据表，缓存的数据页面数量 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> p<span class="token punctuation">.</span>object_id<span class="token punctuation">,</span> object_name<span class="token operator">=</span>object_name<span class="token punctuation">(</span>p<span class="token punctuation">.</span>object_id<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>index_id<span class="token punctuation">,</span> buffer_pages<span class="token operator">=</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> sys<span class="token punctuation">.</span>allocation_units a<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>    sys<span class="token punctuation">.</span>dm_os_buffer_descriptors b<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>    sys<span class="token punctuation">.</span>partitions p </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">where</span> a<span class="token punctuation">.</span>allocation_unit_id<span class="token operator">=</span>b<span class="token punctuation">.</span>allocation_unit_id </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token operator">and</span> a<span class="token punctuation">.</span>container_id<span class="token operator">=</span>p<span class="token punctuation">.</span>hobt_id </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token operator">and</span> b<span class="token punctuation">.</span>database_id<span class="token operator">=</span>db_id<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">group</span> <span class="token keyword">by</span> p<span class="token punctuation">.</span>object_id<span class="token punctuation">,</span>p<span class="token punctuation">.</span>index_id </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> buffer_pages <span class="token keyword">desc</span></pre></td></tr></table></figure><ol start="11"><li>查询缓存的各类执行计划，及分别占了多少内存 （系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> cacheobjtype</pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token punctuation">,</span> objtype</pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>cast<span class="token punctuation">(</span>size_in_bytes <span class="token keyword">as</span> <span class="token keyword">bigint</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">as</span> size_in_kb</pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span>bucketid<span class="token punctuation">)</span> <span class="token keyword">as</span> cache_count</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span>    sys<span class="token punctuation">.</span>dm_exec_cached_plans</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">group</span> <span class="token keyword">by</span> cacheobjtype<span class="token punctuation">,</span> objtype</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> cacheobjtype<span class="token punctuation">,</span> objtype</pre></td></tr></table></figure><ol start="12"><li>查询缓存中具体的执行计划，及对应的 SQL (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span>  usecounts <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        refcounts <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        size_in_bytes <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        cacheobjtype <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        objtype <span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">TEXT</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_cached_plans cp</pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>plan_handle<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> objtype <span class="token keyword">DESC</span> <span class="token punctuation">;</span></pre></td></tr></table></figure><ol start="13"><li>查询 sql server 内存整体使用情况 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> object_name<span class="token punctuation">,</span> cntr_value<span class="token operator">*</span><span class="token number">0.1</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token punctuation">,</span>cntr_value<span class="token punctuation">,</span>cntr_type<span class="token punctuation">,</span>t<span class="token punctuation">.</span>counter_name<span class="token punctuation">,</span>t<span class="token punctuation">.</span>instance_name</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_os_performance_counters t</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">WHERE</span> counter_name <span class="token operator">=</span> <span class="token string">'Total Server Memory (KB)'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ol start="14"><li>一次性清除数据库所有表的数据（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> sp_DeleteAllData  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">AS</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">EXEC</span> sp_MSForEachTable <span class="token string">'ALTER TABLE ? NOCHECK CONSTRAINT ALL'</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">EXEC</span> sp_MSForEachTable <span class="token string">'ALTER TABLE ? DISABLE TRIGGER ALL'</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">EXEC</span> sp_MSForEachTable <span class="token string">'DELETE FROM ?'</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">EXEC</span> sp_MSForEachTable <span class="token string">'ALTER TABLE ? CHECK CONSTRAINT ALL'</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">EXEC</span> sp_MSForEachTable <span class="token string">'ALTER TABLE ? ENABLE TRIGGER ALL'</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">EXEC</span> sp_MSFOREACHTABLE <span class="token string">'SELECT * FROM ?'</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>GO</pre></td></tr></table></figure><ol start="15"><li>SQL 优化相关、执行时间 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> creation_time  N<span class="token string">'语句编译时间'</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token punctuation">,</span>last_execution_time  N<span class="token string">'上次执行时间'</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">,</span>total_physical_reads N<span class="token string">'物理读取总次数'</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token punctuation">,</span>total_logical_reads<span class="token operator">/</span>execution_count N<span class="token string">'每次逻辑读次数'</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token punctuation">,</span>total_logical_reads  N<span class="token string">'逻辑读取总次数'</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">,</span>total_logical_writes N<span class="token string">'逻辑写入总次数'</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">,</span>execution_count  N<span class="token string">'执行次数'</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">,</span>total_worker_time<span class="token operator">/</span><span class="token number">1000</span> N<span class="token string">'所用的CPU总时间ms'</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">,</span>total_elapsed_time<span class="token operator">/</span><span class="token number">1000</span>  N<span class="token string">'总花费时间ms'</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">,</span><span class="token punctuation">(</span>total_elapsed_time <span class="token operator">/</span> execution_count<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span>  N<span class="token string">'平均时间ms'</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">,</span>SUBSTRING<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span>statement_start_offset<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> statement_end_offset   </pre></td></tr><tr><td data-num="13"></td><td><pre>          <span class="token keyword">WHEN</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">THEN</span> DATALENGTH<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token keyword">ELSE</span> qs<span class="token punctuation">.</span>statement_end_offset <span class="token keyword">END</span>   </pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token operator">-</span> qs<span class="token punctuation">.</span>statement_start_offset<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> N<span class="token string">'执行语句'</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_query_stats <span class="token keyword">AS</span> qs  </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> st  </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">WHERE</span> SUBSTRING<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>qs<span class="token punctuation">.</span>statement_start_offset<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> statement_end_offset   </pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token keyword">WHEN</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">THEN</span> DATALENGTH<span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token keyword">ELSE</span> qs<span class="token punctuation">.</span>statement_end_offset <span class="token keyword">END</span>   </pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token operator">-</span> qs<span class="token punctuation">.</span>statement_start_offset<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%fetch%'</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span>  total_elapsed_time <span class="token operator">/</span> execution_count <span class="token keyword">DESC</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ol start="16"><li>truncate 外键表存储过程（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">USE</span> PIMS</pre></td></tr><tr><td data-num="2"></td><td><pre>GO</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>usp_Truncate_Table<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token variable">@TableToTruncate</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">AS</span> </pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">SET</span> NOCOUNT <span class="token keyword">ON</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">--== 变量定义</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@i</span> <span class="token keyword">int</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@Debug</span> <span class="token keyword">bit</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@Recycle</span> <span class="token keyword">bit</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@Verbose</span> <span class="token keyword">bit</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@TableName</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@ColumnName</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@ReferencedTableName</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@ReferencedColumnName</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@ConstraintName</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@CreateStatement</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@DropStatement</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@TruncateStatement</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@CreateStatementTemp</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@DropStatementTemp</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@TruncateStatementTemp</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@Statement</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token keyword">SET</span> <span class="token variable">@Debug</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token comment">--(0: 将执行相关语句 | 1: 不执行语句)</span></pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token keyword">SET</span> <span class="token variable">@Recycle</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token comment">--(0: 不创建 / 不清除存储表 | 1: 将创建 / 清理存储表)</span></pre></td></tr><tr><td data-num="33"></td><td><pre> <span class="token keyword">set</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token comment">--(1: 每步执行均打印消息 | 0: 不打印消息)</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token keyword">SET</span> <span class="token variable">@i</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">SET</span> <span class="token variable">@CreateStatement</span> <span class="token operator">=</span> <span class="token string">'ALTER TABLE [dbo].[&lt;tablename>]  WITH NOCHECK ADD  CONSTRAINT [&lt;constraintname>] FOREIGN KEY([&lt;column>]) REFERENCES [dbo].[&lt;reftable>] ([&lt;refcolumn>])'</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">SET</span> <span class="token variable">@DropStatement</span> <span class="token operator">=</span> <span class="token string">'ALTER TABLE [dbo].[&lt;tablename>] DROP CONSTRAINT [&lt;constraintname>]'</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">SET</span> <span class="token variable">@TruncateStatement</span> <span class="token operator">=</span> <span class="token string">'TRUNCATE TABLE [&lt;tablename>]'</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">-- 创建外键临时表</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">IF</span> OBJECT_ID<span class="token punctuation">(</span><span class="token string">'tempdb..#FKs'</span><span class="token punctuation">)</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token comment">#FKs</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">-- 获取外键</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token keyword">SELECT</span> ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> OBJECT_NAME<span class="token punctuation">(</span>parent_object_id<span class="token punctuation">)</span><span class="token punctuation">,</span> clm1<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">as</span> ID<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>       OBJECT_NAME<span class="token punctuation">(</span>constraint_object_id<span class="token punctuation">)</span> <span class="token keyword">as</span> ConstraintName<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>       OBJECT_NAME<span class="token punctuation">(</span>parent_object_id<span class="token punctuation">)</span> <span class="token keyword">as</span> TableName<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>       clm1<span class="token punctuation">.</span>name <span class="token keyword">as</span> ColumnName<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="49"></td><td><pre>       OBJECT_NAME<span class="token punctuation">(</span>referenced_object_id<span class="token punctuation">)</span> <span class="token keyword">as</span> ReferencedTableName<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>       clm2<span class="token punctuation">.</span>name <span class="token keyword">as</span> ReferencedColumnName</pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">INTO</span> <span class="token comment">#FKs</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>foreign_key_columns fk</pre></td></tr><tr><td data-num="53"></td><td><pre>       <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span><span class="token keyword">columns</span> clm1 <span class="token keyword">ON</span> fk<span class="token punctuation">.</span>parent_column_id <span class="token operator">=</span> clm1<span class="token punctuation">.</span>column_id <span class="token operator">AND</span> fk<span class="token punctuation">.</span>parent_object_id <span class="token operator">=</span> clm1<span class="token punctuation">.</span>object_id</pre></td></tr><tr><td data-num="54"></td><td><pre>       <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span><span class="token keyword">columns</span> clm2 <span class="token keyword">ON</span> fk<span class="token punctuation">.</span>referenced_column_id <span class="token operator">=</span> clm2<span class="token punctuation">.</span>column_id <span class="token operator">AND</span> fk<span class="token punctuation">.</span>referenced_object_id<span class="token operator">=</span> clm2<span class="token punctuation">.</span>object_id</pre></td></tr><tr><td data-num="55"></td><td><pre> <span class="token comment">--WHERE OBJECT_NAME(parent_object_id) not in ('//tables that you do not wont to be truncated')</span></pre></td></tr><tr><td data-num="56"></td><td><pre> <span class="token keyword">WHERE</span> OBJECT_NAME<span class="token punctuation">(</span>referenced_object_id<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token variable">@TableToTruncate</span></pre></td></tr><tr><td data-num="57"></td><td><pre> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> OBJECT_NAME<span class="token punctuation">(</span>parent_object_id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment">-- 外键操作 (删除 | 重建) 表</span></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token keyword">IF</span> <span class="token operator">Not</span> <span class="token keyword">EXISTS</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token keyword">FROM</span> INFORMATION_SCHEMA<span class="token punctuation">.</span><span class="token keyword">TABLES</span> <span class="token keyword">WHERE</span> TABLE_NAME <span class="token operator">=</span> <span class="token string">'Internal_FK_Definition_Storage'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">PRINT</span> <span class="token string">'1. 正在创建表(Internal_FK_Definition_Storage)...'</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span>Internal_FK_Definition_Storage<span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        ID <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">identity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        FK_Name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        FK_CreationStatement <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        FK_DestructionStatement <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        Table_TruncationStatement <span class="token keyword">varchar</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token keyword">END</span> </pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">IF</span> <span class="token variable">@Recycle</span> <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">PRINT</span> <span class="token string">'1. 正在清理表(Internal_FK_Definition_Storage)...'</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">TRUNCATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span>Internal_FK_Definition_Storage<span class="token punctuation">]</span>    </pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">END</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token keyword">PRINT</span> <span class="token string">'1. 正在清理表(Internal_FK_Definition_Storage)...'</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token keyword">END</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token keyword">IF</span> <span class="token variable">@Recycle</span> <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="86"></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token keyword">PRINT</span> <span class="token string">'2. 正在备份外键定义...'</span>           </pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">WHILE</span> <span class="token punctuation">(</span><span class="token variable">@i</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token comment">#FKs))</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token keyword">SET</span> <span class="token variable">@ConstraintName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> ConstraintName <span class="token keyword">FROM</span> <span class="token comment">#FKs WHERE ID = @i)</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token keyword">SET</span> <span class="token variable">@TableName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> TableName <span class="token keyword">FROM</span> <span class="token comment">#FKs WHERE ID = @i)</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token keyword">SET</span> <span class="token variable">@ColumnName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> ColumnName <span class="token keyword">FROM</span> <span class="token comment">#FKs WHERE ID = @i)</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token keyword">SET</span> <span class="token variable">@ReferencedTableName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> ReferencedTableName <span class="token keyword">FROM</span> <span class="token comment">#FKs WHERE ID = @i)</span></pre></td></tr><tr><td data-num="95"></td><td><pre>        <span class="token keyword">SET</span> <span class="token variable">@ReferencedColumnName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> ReferencedColumnName <span class="token keyword">FROM</span> <span class="token comment">#FKs WHERE ID = @i)</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre>        <span class="token keyword">SET</span> <span class="token variable">@DropStatementTemp</span> <span class="token operator">=</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token variable">@DropStatement</span><span class="token punctuation">,</span><span class="token string">'&lt;tablename>'</span><span class="token punctuation">,</span><span class="token variable">@TableName</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'&lt;constraintname>'</span><span class="token punctuation">,</span><span class="token variable">@ConstraintName</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        <span class="token keyword">SET</span> <span class="token variable">@CreateStatementTemp</span> <span class="token operator">=</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token variable">@CreateStatement</span><span class="token punctuation">,</span><span class="token string">'&lt;tablename>'</span><span class="token punctuation">,</span><span class="token variable">@TableName</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'&lt;column>'</span><span class="token punctuation">,</span><span class="token variable">@ColumnName</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'&lt;constraintname>'</span><span class="token punctuation">,</span><span class="token variable">@ConstraintName</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'&lt;reftable>'</span><span class="token punctuation">,</span><span class="token variable">@ReferencedTableName</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'&lt;refcolumn>'</span><span class="token punctuation">,</span><span class="token variable">@ReferencedColumnName</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token keyword">SET</span> <span class="token variable">@TruncateStatementTemp</span> <span class="token operator">=</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token variable">@TruncateStatement</span><span class="token punctuation">,</span><span class="token string">'&lt;tablename>'</span><span class="token punctuation">,</span><span class="token variable">@TableName</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="100"></td><td><pre></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">[</span>Internal_FK_Definition_Storage<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        <span class="token keyword">SELECT</span> <span class="token variable">@ConstraintName</span><span class="token punctuation">,</span> <span class="token variable">@CreateStatementTemp</span><span class="token punctuation">,</span> <span class="token variable">@DropStatementTemp</span><span class="token punctuation">,</span> <span class="token variable">@TruncateStatementTemp</span></pre></td></tr><tr><td data-num="103"></td><td><pre>        </pre></td></tr><tr><td data-num="104"></td><td><pre>        <span class="token keyword">SET</span> <span class="token variable">@i</span> <span class="token operator">=</span> <span class="token variable">@i</span> <span class="token operator">+</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        </pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="107"></td><td><pre>            <span class="token keyword">PRINT</span> <span class="token string">'  > 已备份外键:['</span> <span class="token operator">+</span> <span class="token variable">@ConstraintName</span> <span class="token operator">+</span> <span class="token string">'] 所属表: ['</span> <span class="token operator">+</span> <span class="token variable">@TableName</span> <span class="token operator">+</span> <span class="token string">']'</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token keyword">END</span>   </pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token keyword">END</span>   </pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token keyword">ELSE</span> </pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token keyword">PRINT</span> <span class="token string">'2. 正在备份外键定义...'</span></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token keyword">PRINT</span> <span class="token string">'3. 正在删除外键...'</span></pre></td></tr><tr><td data-num="115"></td><td><pre><span class="token keyword">BEGIN</span> <span class="token keyword">TRAN</span>    </pre></td></tr><tr><td data-num="116"></td><td><pre><span class="token keyword">BEGIN</span> TRY</pre></td></tr><tr><td data-num="117"></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@i</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token keyword">WHILE</span> <span class="token punctuation">(</span><span class="token variable">@i</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token punctuation">[</span>Internal_FK_Definition_Storage<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="119"></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    <span class="token keyword">SET</span> <span class="token variable">@ConstraintName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> FK_Name <span class="token keyword">FROM</span> <span class="token punctuation">[</span>Internal_FK_Definition_Storage<span class="token punctuation">]</span> <span class="token keyword">WHERE</span> ID <span class="token operator">=</span> <span class="token variable">@i</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token keyword">SET</span> <span class="token variable">@Statement</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> FK_DestructionStatement <span class="token keyword">FROM</span> <span class="token punctuation">[</span>Internal_FK_Definition_Storage<span class="token punctuation">]</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>NOLOCK<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> ID <span class="token operator">=</span> <span class="token variable">@i</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    <span class="token keyword">IF</span> <span class="token variable">@Debug</span> <span class="token operator">=</span> <span class="token number">1</span> </pre></td></tr><tr><td data-num="123"></td><td><pre>        <span class="token keyword">PRINT</span> <span class="token variable">@Statement</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num="125"></td><td><pre>        <span class="token keyword">EXEC</span><span class="token punctuation">(</span><span class="token variable">@Statement</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="126"></td><td><pre>    <span class="token keyword">SET</span> <span class="token variable">@i</span> <span class="token operator">=</span> <span class="token variable">@i</span> <span class="token operator">+</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="128"></td><td><pre>        <span class="token keyword">PRINT</span> <span class="token string">'  > 已删除外键:['</span> <span class="token operator">+</span> <span class="token variable">@ConstraintName</span> <span class="token operator">+</span> <span class="token string">']'</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token keyword">END</span>     </pre></td></tr><tr><td data-num="130"></td><td><pre></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="132"></td><td><pre>    <span class="token keyword">PRINT</span> <span class="token string">'4. 正在清理数据表...'</span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token comment">-- 先清除该外键所在表 (由于外键所在表仍可能又被其他外键所引用，因此需要循环递归处理)(注：本处理未实现)</span></pre></td></tr><tr><td data-num="134"></td><td><pre><span class="token comment">-- 请不要使用下面注释代码</span></pre></td></tr><tr><td data-num="135"></td><td><pre><span class="token comment">/*    </span></pre></td></tr><tr><td data-num="136"></td><td><pre>SET @i = 1</pre></td></tr><tr><td data-num="137"></td><td><pre>WHILE (@i &lt;= (SELECT MAX(ID) FROM [Internal_FK_Definition_Storage]))</pre></td></tr><tr><td data-num="138"></td><td><pre>BEGIN</pre></td></tr><tr><td data-num="139"></td><td><pre>    SET @Statement = (SELECT Table_TruncationStatement FROM [Internal_FK_Definition_Storage] WHERE ID = @i)</pre></td></tr><tr><td data-num="140"></td><td><pre>    IF @Debug = 1 </pre></td></tr><tr><td data-num="141"></td><td><pre>        PRINT @Statement</pre></td></tr><tr><td data-num="142"></td><td><pre>    ELSE</pre></td></tr><tr><td data-num="143"></td><td><pre>        EXEC(@Statement)</pre></td></tr><tr><td data-num="144"></td><td><pre>    SET @i = @i + 1</pre></td></tr><tr><td data-num="145"></td><td><pre>    IF @Verbose = 1</pre></td></tr><tr><td data-num="146"></td><td><pre>        PRINT '  > ' + @Statement</pre></td></tr><tr><td data-num="147"></td><td><pre>END</pre></td></tr><tr><td data-num="148"></td><td><pre>*/</pre></td></tr><tr><td data-num="149"></td><td><pre></pre></td></tr><tr><td data-num="150"></td><td><pre><span class="token keyword">IF</span> <span class="token variable">@Debug</span> <span class="token operator">=</span> <span class="token number">1</span> </pre></td></tr><tr><td data-num="151"></td><td><pre>    <span class="token keyword">PRINT</span> <span class="token string">'TRUNCATE TABLE ['</span> <span class="token operator">+</span> <span class="token variable">@TableToTruncate</span> <span class="token operator">+</span> <span class="token string">']'</span></pre></td></tr><tr><td data-num="152"></td><td><pre><span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num="153"></td><td><pre>    <span class="token keyword">EXEC</span><span class="token punctuation">(</span><span class="token string">'TRUNCATE TABLE ['</span> <span class="token operator">+</span> <span class="token variable">@TableToTruncate</span> <span class="token operator">+</span> <span class="token string">']'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="154"></td><td><pre><span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="155"></td><td><pre>    <span class="token keyword">PRINT</span> <span class="token string">'  > 已清理数据表['</span> <span class="token operator">+</span> <span class="token variable">@TableToTruncate</span> <span class="token operator">+</span> <span class="token string">']'</span></pre></td></tr><tr><td data-num="156"></td><td><pre>    </pre></td></tr><tr><td data-num="157"></td><td><pre><span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="158"></td><td><pre>    <span class="token keyword">PRINT</span> <span class="token string">'5. 正在重建外键...'</span></pre></td></tr><tr><td data-num="159"></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@i</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="160"></td><td><pre><span class="token keyword">WHILE</span> <span class="token punctuation">(</span><span class="token variable">@i</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token punctuation">[</span>Internal_FK_Definition_Storage<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="162"></td><td><pre>    <span class="token keyword">SET</span> <span class="token variable">@ConstraintName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> FK_Name <span class="token keyword">FROM</span> <span class="token punctuation">[</span>Internal_FK_Definition_Storage<span class="token punctuation">]</span> <span class="token keyword">WHERE</span> ID <span class="token operator">=</span> <span class="token variable">@i</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="163"></td><td><pre>    <span class="token keyword">SET</span> <span class="token variable">@Statement</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> FK_CreationStatement <span class="token keyword">FROM</span> <span class="token punctuation">[</span>Internal_FK_Definition_Storage<span class="token punctuation">]</span> <span class="token keyword">WHERE</span> ID <span class="token operator">=</span> <span class="token variable">@i</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="164"></td><td><pre>    <span class="token keyword">IF</span> <span class="token variable">@Debug</span> <span class="token operator">=</span> <span class="token number">1</span> </pre></td></tr><tr><td data-num="165"></td><td><pre>        <span class="token keyword">PRINT</span> <span class="token variable">@Statement</span></pre></td></tr><tr><td data-num="166"></td><td><pre>    <span class="token keyword">ELSE</span></pre></td></tr><tr><td data-num="167"></td><td><pre>        <span class="token keyword">EXEC</span><span class="token punctuation">(</span><span class="token variable">@Statement</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token keyword">SET</span> <span class="token variable">@i</span> <span class="token operator">=</span> <span class="token variable">@i</span> <span class="token operator">+</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="169"></td><td><pre>    <span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="170"></td><td><pre>    <span class="token keyword">PRINT</span> <span class="token string">'  > 已重建外键:['</span> <span class="token operator">+</span> <span class="token variable">@ConstraintName</span> <span class="token operator">+</span> <span class="token string">']'</span></pre></td></tr><tr><td data-num="171"></td><td><pre><span class="token keyword">END</span></pre></td></tr><tr><td data-num="172"></td><td><pre>    <span class="token keyword">COMMIT</span></pre></td></tr><tr><td data-num="173"></td><td><pre><span class="token keyword">END</span> TRY</pre></td></tr><tr><td data-num="174"></td><td><pre><span class="token keyword">BEGIN</span> CATCH</pre></td></tr><tr><td data-num="175"></td><td><pre>    <span class="token keyword">ROLLBACK</span> </pre></td></tr><tr><td data-num="176"></td><td><pre>    <span class="token keyword">PRINT</span> <span class="token string">'出错信息:'</span><span class="token operator">+</span>ERROR_MESSAGE<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="177"></td><td><pre><span class="token keyword">END</span> CATCH</pre></td></tr><tr><td data-num="178"></td><td><pre><span class="token keyword">IF</span> <span class="token variable">@Verbose</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="179"></td><td><pre>    <span class="token keyword">PRINT</span> <span class="token string">'6. 处理完成！'</span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token keyword">END</span></pre></td></tr></table></figure><ol start="17"><li>查看 job 运行持续时间 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> </pre></td></tr><tr><td data-num="2"></td><td><pre>     <span class="token punctuation">[</span>T1<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>job_id<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">,</span><span class="token punctuation">[</span>T1<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>job_name<span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">,</span><span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>run_status<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">,</span><span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>run_date<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">,</span><span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>run_time<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">,</span><span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>agent_datetime<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>run_date<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>run_time<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>run_datetime<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">,</span><span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>run_duration<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">,</span>DATEDIFF<span class="token punctuation">(</span><span class="token keyword">SECOND</span><span class="token punctuation">,</span> <span class="token string">'1900-01-01'</span><span class="token punctuation">,</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">SECOND</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>agent_datetime<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">19000101</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>run_duration<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>run_duration_s<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">FROM</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>sysjobs<span class="token punctuation">]</span> <span class="token keyword">AS</span> T1</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>sysjobhistory<span class="token punctuation">]</span> <span class="token keyword">AS</span> T2</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">ON</span> <span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>job_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>T1<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>job_id<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">WHERE</span> </pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">[</span>T1<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>enabled<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token operator">AND</span> <span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>step_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token operator">AND</span> <span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>run_duration<span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token operator">and</span> <span class="token punctuation">[</span>T1<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'PIMS_CreatePaperCraftParameterAnalysisData'</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span></pre></td></tr><tr><td data-num="20"></td><td><pre>     <span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>job_id<span class="token punctuation">]</span> <span class="token keyword">ASC</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">,</span><span class="token punctuation">[</span>T2<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>run_date<span class="token punctuation">]</span> <span class="token keyword">ASC</span></pre></td></tr><tr><td data-num="22"></td><td><pre>GO</pre></td></tr></table></figure><ol start="18"><li>从所有缓存中释放所有未使用的缓存条目 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">DBCC</span> FREESYSTEMCACHE<span class="token punctuation">(</span><span class="token string">'ALL'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ol start="19"><li>查询、解除死锁（事务锁)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 创建查询谁被谁锁住的存储过程</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">use</span> master</pre></td></tr><tr><td data-num="3"></td><td><pre>go</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> sp_who_lock<span class="token punctuation">(</span><span class="token variable">@in_spid</span> <span class="token keyword">int</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">as</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">begin</span>   </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">declare</span> <span class="token variable">@spid</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token variable">@bl</span> <span class="token keyword">int</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token variable">@intTransactionCountOnEntry</span>      <span class="token keyword">int</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token variable">@intRowcount</span>              <span class="token keyword">int</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token variable">@intCountProperties</span>          <span class="token keyword">int</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token variable">@intCounter</span>              <span class="token keyword">int</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token comment">#tmp_lock_who (   </span></pre></td></tr><tr><td data-num="13"></td><td><pre>id <span class="token keyword">int</span> <span class="token keyword">identity</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="14"></td><td><pre>spid <span class="token keyword">smallint</span><span class="token punctuation">,</span>   </pre></td></tr><tr><td data-num="15"></td><td><pre>bl <span class="token keyword">smallint</span><span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">IF</span> @<span class="token variable">@ERROR</span><span class="token operator">&lt;></span><span class="token number">0</span> <span class="token keyword">RETURN</span> @<span class="token variable">@ERROR</span>   </pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token comment">#tmp_lock_who(spid,bl) select   0 ,blocked   </span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sysprocesses <span class="token keyword">where</span>   blocked<span class="token operator">></span><span class="token number">0</span> <span class="token punctuation">)</span> a   </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sysprocesses   </pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">where</span>   blocked<span class="token operator">></span><span class="token number">0</span> <span class="token punctuation">)</span> b   </pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">where</span> a<span class="token punctuation">.</span>blocked<span class="token operator">=</span>spid<span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">union</span> <span class="token keyword">select</span> spid<span class="token punctuation">,</span>blocked <span class="token keyword">from</span> sysprocesses <span class="token keyword">where</span>   blocked<span class="token operator">></span><span class="token number">0</span>   </pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">IF</span> @<span class="token variable">@ERROR</span><span class="token operator">&lt;></span><span class="token number">0</span> <span class="token keyword">RETURN</span> @<span class="token variable">@ERROR</span>   </pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">-- 找到临时表的记录数   </span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">select</span>      <span class="token variable">@intCountProperties</span> <span class="token operator">=</span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token variable">@intCounter</span> <span class="token operator">=</span> <span class="token number">1</span>   </pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">from</span> <span class="token comment">#tmp_lock_who   </span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">IF</span> @<span class="token variable">@ERROR</span><span class="token operator">&lt;></span><span class="token number">0</span> <span class="token keyword">RETURN</span> @<span class="token variable">@ERROR</span>   </pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">if</span>     <span class="token variable">@intCountProperties</span><span class="token operator">=</span><span class="token number">0</span>   </pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">select</span> <span class="token string">'现在没有阻塞和死锁信息'</span> <span class="token keyword">as</span> message   </pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">-- 循环开始   </span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">while</span> <span class="token variable">@intCounter</span> <span class="token operator">&lt;=</span> <span class="token variable">@intCountProperties</span>   </pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">begin</span>   </pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">-- 取第一条记录   </span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">select</span>      <span class="token variable">@spid</span> <span class="token operator">=</span> <span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token variable">@in_spid</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> spid <span class="token keyword">else</span> <span class="token variable">@in_spid</span> <span class="token keyword">end</span><span class="token punctuation">,</span><span class="token variable">@bl</span> <span class="token operator">=</span> bl   </pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">from</span> <span class="token comment">#tmp_lock_who where Id = @intCounter   </span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">begin</span>   </pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">if</span> <span class="token variable">@spid</span> <span class="token operator">=</span><span class="token number">0</span>   </pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">select</span> <span class="token string">'引起数据库死锁的是: '</span><span class="token operator">+</span> CAST<span class="token punctuation">(</span><span class="token variable">@bl</span> <span class="token keyword">AS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token operator">+</span> <span class="token string">'进程号,其执行的SQL语法如下'</span>  </pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">else</span>  </pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">select</span> <span class="token string">'进程号SPID：'</span><span class="token operator">+</span> CAST<span class="token punctuation">(</span><span class="token variable">@spid</span> <span class="token keyword">AS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">'被'</span>  </pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token operator">+</span> <span class="token string">'进程号SPID：'</span><span class="token operator">+</span> CAST<span class="token punctuation">(</span><span class="token variable">@bl</span> <span class="token keyword">AS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'阻塞,其当前进程执行的SQL语法如下'</span>  </pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token keyword">DBCC</span> INPUTBUFFER <span class="token punctuation">(</span><span class="token variable">@bl</span> <span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">end</span>   </pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment">-- 循环指针下移   </span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">set</span> <span class="token variable">@intCounter</span> <span class="token operator">=</span> <span class="token variable">@intCounter</span> <span class="token operator">+</span> <span class="token number">1</span>   </pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">end</span>   </pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token comment">#tmp_lock_who   </span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">return</span> <span class="token number">0</span>   </pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token keyword">end</span></pre></td></tr><tr><td data-num="51"></td><td><pre>GO  </pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">-- 查询表死锁信息</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token keyword">select</span> object_name<span class="token punctuation">(</span>resource_associated_entity_id<span class="token punctuation">)</span> <span class="token keyword">as</span> tableName<span class="token punctuation">,</span> request_session_id <span class="token keyword">as</span> pid <span class="token keyword">from</span> sys<span class="token punctuation">.</span>dm_tran_locks</pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">where</span> resource_type <span class="token operator">=</span> <span class="token string">'OBJECT'</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token keyword">dbcc</span> opentran</pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token comment">-- 查看指定 pid 死锁的详细信息、执行的 sql 语句</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token keyword">exec</span> sp_who_lock <span class="token number">53</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token comment">-- 查询所有死锁的详细信息、执行的 sql 语句</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token keyword">exec</span> sp_who_lock <span class="token number">0</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre><span class="token keyword">DBCC</span> inputbuffer <span class="token punctuation">(</span><span class="token number">53</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment">-- 解除死锁</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token keyword">kill</span> <span class="token number">53</span></pre></td></tr></table></figure><ol start="20"><li>查询 SQL Server 根据 CPU 消耗列出前 5 个最差性能的查询 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- Worst performing CPU bound queries</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    qp<span class="token punctuation">.</span>query_plan<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    qs<span class="token punctuation">.</span><span class="token operator">*</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_query_stats qs</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>plan_handle<span class="token punctuation">)</span> st</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_query_plan<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>plan_handle<span class="token punctuation">)</span> qp</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> total_worker_time <span class="token keyword">DESC</span></pre></td></tr><tr><td data-num="10"></td><td><pre>GO</pre></td></tr></table></figure><ol start="21"><li>显示如何依据 I/O 消耗来找出你性能最差的查询 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- Worst performing I/O bound queries</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    st<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    qp<span class="token punctuation">.</span>query_plan<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    qs<span class="token punctuation">.</span><span class="token operator">*</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_query_stats qs</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>plan_handle<span class="token punctuation">)</span> st</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_query_plan<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>plan_handle<span class="token punctuation">)</span> qp</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> total_logical_reads <span class="token keyword">DESC</span></pre></td></tr><tr><td data-num="10"></td><td><pre>GO</pre></td></tr></table></figure><ol start="22"><li>查询服务器部分特殊信息（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> SERVERPROPERTY<span class="token punctuation">(</span>N<span class="token string">'edition'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Edition     <span class="token comment">-- 数据版本，如企业版、开发版等</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">,</span>SERVERPROPERTY<span class="token punctuation">(</span>N<span class="token string">'collation'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Collation   <span class="token comment">-- 数据库字符集</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">,</span>SERVERPROPERTY<span class="token punctuation">(</span>N<span class="token string">'servername'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ServerName <span class="token comment">-- 服务名</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">,</span>@<span class="token variable">@VERSION</span> <span class="token keyword">as</span> Version   <span class="token comment">-- 数据库版本号</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">,</span>@<span class="token variable">@LANGUAGE</span> <span class="token keyword">AS</span> <span class="token keyword">Language</span>  <span class="token comment">-- 数据库使用的语言，如 us_english 等</span></pre></td></tr></table></figure><ol start="23"><li>查询数据库中各数据表大小（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- =============================================</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">-- 描  述：更新查询数据库中各表的大小，结果存储到数据表中</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- =============================================</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">-- 查询是否存在结果存储表</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sysobjects <span class="token keyword">where</span> id <span class="token operator">=</span> OBJECT_ID<span class="token punctuation">(</span>N<span class="token string">'temp_tableSpaceInfo'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> OBJECTPROPERTY<span class="token punctuation">(</span>id<span class="token punctuation">,</span> N<span class="token string">'IsUserTable'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">-- 不存在则创建</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> temp_tableSpaceInfo</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">(</span>name NVARCHAR<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">rows</span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="12"></td><td><pre>        reserved <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">data</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        index_size <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        unused <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">END</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">-- 清空数据表</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> temp_tableSpaceInfo</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">-- 定义临时变量在遍历时存储表名称</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">DECLARE</span> <span class="token variable">@tablename</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">-- 使用游标读取数据库内所有表表名</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">DECLARE</span> table_list_cursor <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> </pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> sysobjects </pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">WHERE</span> OBJECTPROPERTY<span class="token punctuation">(</span>id<span class="token punctuation">,</span> N<span class="token string">'IsTable'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> name <span class="token operator">NOT</span> <span class="token operator">LIKE</span> N<span class="token string">'#%%'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> name</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">-- 打开游标</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">OPEN</span> table_list_cursor</pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">-- 读取第一条数据</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">FETCH</span> <span class="token keyword">NEXT</span> <span class="token keyword">FROM</span> table_list_cursor <span class="token keyword">INTO</span> <span class="token variable">@tablename</span> </pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">-- 遍历查询到的表名</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">WHILE</span> @<span class="token variable">@FETCH_STATUS</span> <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">-- 检查当前表是否为用户表</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sysobjects <span class="token keyword">WHERE</span> id <span class="token operator">=</span> OBJECT_ID<span class="token punctuation">(</span><span class="token variable">@tablename</span><span class="token punctuation">)</span> <span class="token operator">AND</span> OBJECTPROPERTY<span class="token punctuation">(</span>id<span class="token punctuation">,</span> N<span class="token string">'IsUserTable'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">BEGIN</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token comment">-- 当前表则读取其信息插入到表格中</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token keyword">EXECUTE</span> sp_executesql N<span class="token string">'INSERT INTO temp_tableSpaceInfo EXEC sp_spaceused @tbname'</span><span class="token punctuation">,</span> N<span class="token string">'@tbname varchar(255)'</span><span class="token punctuation">,</span> <span class="token variable">@tbname</span> <span class="token operator">=</span> <span class="token variable">@tablename</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">END</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token comment">-- 读取下一条数据</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">FETCH</span> <span class="token keyword">NEXT</span> <span class="token keyword">FROM</span> table_list_cursor <span class="token keyword">INTO</span> <span class="token variable">@tablename</span> </pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">END</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">-- 释放游标</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">CLOSE</span> table_list_cursor</pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">DEALLOCATE</span> table_list_cursor</pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token keyword">replace</span><span class="token punctuation">(</span>reserved<span class="token punctuation">,</span><span class="token string">'KB'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span> 数据表大小M <span class="token keyword">FROM</span> temp_tableSpaceInfo <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">replace</span><span class="token punctuation">(</span>reserved<span class="token punctuation">,</span><span class="token string">'KB'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">desc</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">drop</span> <span class="token keyword">table</span> temp_tableSpaceInfo</pre></td></tr></table></figure><ol start="24"><li>压缩数据库、文件、日志（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">DBCC</span> ShrinkFile<span class="token punctuation">(</span>‘数据库名’<span class="token punctuation">,</span>  targetsize<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/* 收缩数据库文件 */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">DBCC</span> ShrinkFile<span class="token punctuation">(</span>‘数据库名_log’<span class="token punctuation">,</span>  targetsize<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 收缩日志文件 */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>Targetsize：单位为兆，必须为整数，<span class="token keyword">DBCC</span> SHRINKFILE 尝试将文件收缩到指定大小。</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">DBCC</span> SHRINKFILE 不会将文件收缩到小于“实际使用的空间”大小，例如“分配空间”为<span class="token number">10</span>M，“实际使用空间”为<span class="token number">6</span>M，当制定targetsize为<span class="token number">1</span>时，则将该文件收缩到<span class="token number">6</span>M，不会将文件收缩到<span class="token number">1</span>M。</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">-- 收缩数据库</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">DBCC</span> SHRINKDATABASE<span class="token punctuation">(</span>数据库名，百分比<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>百分比：即“收缩后文件中的最大可用空间”，取值范围“大于等于<span class="token number">0</span>， 小于<span class="token number">100</span><span class="token operator">%</span>”，实际使用中设为<span class="token number">0</span>即可。</pre></td></tr></table></figure><ol start="26"><li>数据库对象信息检索（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 查看对象的说明信息</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">exec</span> sp_help <span class="token string">'T_papermachine'</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 显示视图、存储过程、函数、触发器的定义脚本。 </span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">exec</span> sp_helptext <span class="token string">'proc_report_getmeasuredata'</span> </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 显示表的行数和占用空间。  </span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">exec</span> sp_spaceused  <span class="token string">'T_papermachine'</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">-- 显示表或视图的前 100 行，选定 “tablename,1000” 按 Ctrl+F1 可显示表的前 1000 行。</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">exec</span> sp_executesql N<span class="token string">'IF OBJECT_ID(@tablename) IS NOT NULL EXEC(N''SELECT TOP(''+@n+N'') * FROM ''+@tablename)'</span><span class="token punctuation">,</span>N<span class="token string">'@tablename nvarchar(100)=''t_papermachine'',@n int=100'</span> </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">-- 显示表中每个索引占用的空间。  </span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">exec</span> sp_executesql N<span class="token string">'SELECT index_name = ind.name, ddps.used_page_count, ddps.reserved_page_count, ddps.row_count FROM sys.indexes ind INNER JOIN sys.dm_db_partition_stats ddps ON ind.object_id = ddps.object_id AND ind.index_id = ddps.index_id WHERE ind.object_id = OBJECT_ID(@tablename)'</span><span class="token punctuation">,</span>N<span class="token string">'@tablename nvarchar(100)=''t_papermachine'''</span> </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">-- 显示表或视图的字段名，以逗号分隔。  </span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">exec</span> sp_executesql N<span class="token string">'SELECT columns = STUFF((SELECT '', ''+name FROM sys.columns WHERE object_id = OBJECT_ID(@tablename) FOR XML PATH('''')),1,2,'''')'</span><span class="token punctuation">,</span>N<span class="token string">'@tablename nvarchar(100)=''T_Papermachine'''</span> </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">-- 根据选定关键词在当前数据库中查找表、视图、存储过程、函数  </span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">exec</span> sp_executesql N<span class="token string">'SELECT * FROM sys.objects WHERE type IN (''U'',''V'',''P'',''FN'') AND name LIKE ''%''+@keyword+''%'' ORDER BY type,name'</span><span class="token punctuation">,</span>N<span class="token string">'@keyword nvarchar(50)=''machine'''</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">-- 查询数据库中包含指定关键词的表、视图、存储过程、函数</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">select</span> routine_name<span class="token punctuation">,</span>routine_definition<span class="token punctuation">,</span>routine_type</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>routines</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">where</span> routine_definition <span class="token operator">like</span> <span class="token string">'%AssessmentSpeed%'</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> routine_type</pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">-- 模糊查询存储过程 sql 中包含某个文本</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">SELECT</span> obj<span class="token punctuation">.</span>Name 存储过程名<span class="token punctuation">,</span> sc<span class="token punctuation">.</span><span class="token keyword">TEXT</span> 存储过程内容</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">FROM</span> syscomments sc</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sysobjects obj <span class="token keyword">ON</span> sc<span class="token punctuation">.</span>Id <span class="token operator">=</span> obj<span class="token punctuation">.</span>ID</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">WHERE</span> sc<span class="token punctuation">.</span><span class="token keyword">TEXT</span> <span class="token operator">LIKE</span> <span class="token string">'%存储过程内容%'</span></pre></td></tr></table></figure><ol start="27"><li>数据库用户、权限操作（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">USE</span> <span class="token punctuation">[</span>master<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre>GO</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 待确认账号密码</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">CREATE</span> LOGIN <span class="token punctuation">[</span>NDIT<span class="token punctuation">]</span> <span class="token keyword">WITH</span> PASSWORD<span class="token operator">=</span>N<span class="token string">'1'</span><span class="token punctuation">,</span> DEFAULT_DATABASE<span class="token operator">=</span><span class="token punctuation">[</span>PIMS<span class="token punctuation">]</span><span class="token punctuation">,</span> CHECK_EXPIRATION<span class="token operator">=</span><span class="token keyword">OFF</span><span class="token punctuation">,</span> CHECK_POLICY<span class="token operator">=</span><span class="token keyword">OFF</span></pre></td></tr><tr><td data-num="5"></td><td><pre>GO</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">USE</span> PIMS</pre></td></tr><tr><td data-num="7"></td><td><pre>go</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token punctuation">[</span>NDIT<span class="token punctuation">]</span> <span class="token keyword">FOR</span> LOGIN <span class="token punctuation">[</span>NDIT<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>GO</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">-- 大权限， 如果是指定的部分表，不执行这个，如果是所有内容都可以读，用此脚本</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">--EXEC sp_addrolemember N'db_datareader', N'NDIT'</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">--GO</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">-- 指定特定表名赋予新增 / 更新 / 查询</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@Sql</span> NVARCHAR<span class="token punctuation">(</span>max<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">SET</span> <span class="token variable">@Sql</span><span class="token operator">=</span><span class="token string">''</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">--table</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">--SELECT @Sql=@Sql+'GRANT INSERT,UPDATE,SELECT ON ['+a.name+'] TO [NDIT];' FROM sys.tables AS a WHERE name IN ('Tab1','Tab2');</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">--view</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">--SELECT @Sql=@Sql+'GRANT INSERT,UPDATE,SELECT ON ['+a.name+'] TO [NDIT];' FROM sys.views AS a WHERE name IN ('view1','view2');</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">--procedure</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">--SELECT @Sql=@Sql+'GRANT INSERT,UPDATE,SELECT ON ['+a.name+'] TO [NDIT];' FROM sys.procedures AS a WHERE name IN ('proc1','proc2');</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">PRINT</span> <span class="token variable">@Sql</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">EXEC</span><span class="token punctuation">(</span><span class="token variable">@Sql</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>go</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">-- 禁用登陆帐户</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">--alter login NDIT disable</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">-- 启用登陆帐户</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">--alter login NDIT enable</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">-- 登陆帐户改名</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">--alter login NDIT with name=dba_tom</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">-- 登陆帐户改密码： </span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">--alter login NDIT with password='aabb@ccdd'</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">-- 数据库用户改名： </span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">--alter user NDIT with name=dba_tom</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment">-- 更改数据库用户 defult_schema： </span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment">--alter user NDIT with default_schema=sales</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment">-- 删除数据库用户： </span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">--drop user NDIT</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">-- 删除 SQL Server 登陆帐户： </span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">--drop login NDIT</span></pre></td></tr></table></figure><ol start="28"><li>使用 Checksum 结合 NewID 获得随机数（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">Create</span> <span class="token keyword">FUNCTION</span> Scalar_CheckSumNEWID  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token variable">@From</span> <span class="token keyword">int</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token variable">@To</span> <span class="token keyword">int</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token variable">@Keep</span> <span class="token keyword">int</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token variable">@newid</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">RETURNS</span> <span class="token keyword">float</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">BEGIN</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">DECLARE</span> <span class="token variable">@ResultVar</span> <span class="token keyword">float</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">SELECT</span> <span class="token variable">@ResultVar</span><span class="token operator">=</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">BIGINT</span><span class="token punctuation">,</span><span class="token keyword">RIGHT</span><span class="token punctuation">(</span>ABS<span class="token punctuation">(</span>CHECKSUM<span class="token punctuation">(</span><span class="token variable">@newid</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.1</span><span class="token operator">/</span><span class="token number">100000000</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">RETURN</span> <span class="token variable">@From</span><span class="token operator">+</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">@To</span><span class="token operator">-</span><span class="token variable">@From</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token variable">@ResultVar</span><span class="token punctuation">,</span><span class="token variable">@Keep</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">END</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>GO</pre></td></tr></table></figure><ol start="29"><li>查询数据库表字段各项属性信息，便于直接复制导出 excel 表（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>     表名       <span class="token operator">=</span> <span class="token keyword">Case</span> <span class="token keyword">When</span> A<span class="token punctuation">.</span>colorder<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">Then</span> D<span class="token punctuation">.</span>name <span class="token keyword">Else</span> <span class="token string">''</span> <span class="token keyword">End</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>     表说明     <span class="token operator">=</span> <span class="token keyword">Case</span> <span class="token keyword">When</span> A<span class="token punctuation">.</span>colorder<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">Then</span> isnull<span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">Else</span> <span class="token string">''</span> <span class="token keyword">End</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>     字段序号   <span class="token operator">=</span> A<span class="token punctuation">.</span>colorder<span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre>     字段名     <span class="token operator">=</span> A<span class="token punctuation">.</span>name<span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre>     字段说明   <span class="token operator">=</span> isnull<span class="token punctuation">(</span>G<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token keyword">value</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>     标识       <span class="token operator">=</span> <span class="token keyword">Case</span> <span class="token keyword">When</span> COLUMNPROPERTY<span class="token punctuation">(</span> A<span class="token punctuation">.</span>id<span class="token punctuation">,</span>A<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">'IsIdentity'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">Then</span> <span class="token string">'√'</span><span class="token keyword">Else</span> <span class="token string">''</span> <span class="token keyword">End</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre>     主键       <span class="token operator">=</span> <span class="token keyword">Case</span> <span class="token keyword">When</span> <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token keyword">FROM</span> sysobjects <span class="token keyword">Where</span> xtype<span class="token operator">=</span><span class="token string">'PK'</span> <span class="token operator">and</span> parent_obj<span class="token operator">=</span>A<span class="token punctuation">.</span>id <span class="token operator">and</span> name <span class="token operator">in</span> <span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>                      <span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> sysindexes <span class="token keyword">WHERE</span> indid <span class="token operator">in</span><span class="token punctuation">(</span> <span class="token keyword">SELECT</span> indid <span class="token keyword">FROM</span> sysindexkeys <span class="token keyword">WHERE</span> id <span class="token operator">=</span> A<span class="token punctuation">.</span>id <span class="token operator">AND</span> colid<span class="token operator">=</span>A<span class="token punctuation">.</span>colid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">then</span> <span class="token string">'√'</span> <span class="token keyword">else</span> <span class="token string">''</span> <span class="token keyword">end</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="10"></td><td><pre>     类型       <span class="token operator">=</span> B<span class="token punctuation">.</span>name<span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>     占用字节数 <span class="token operator">=</span> A<span class="token punctuation">.</span>Length<span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="12"></td><td><pre>     长度       <span class="token operator">=</span> COLUMNPROPERTY<span class="token punctuation">(</span>A<span class="token punctuation">.</span>id<span class="token punctuation">,</span>A<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">'PRECISION'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>     小数位数   <span class="token operator">=</span> isnull<span class="token punctuation">(</span>COLUMNPROPERTY<span class="token punctuation">(</span>A<span class="token punctuation">.</span>id<span class="token punctuation">,</span>A<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">'Scale'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="14"></td><td><pre>     允许空     <span class="token operator">=</span> <span class="token keyword">Case</span> <span class="token keyword">When</span> A<span class="token punctuation">.</span>isnullable<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">Then</span> <span class="token string">'√'</span><span class="token keyword">Else</span> <span class="token string">''</span> <span class="token keyword">End</span><span class="token punctuation">,</span>  </pre></td></tr><tr><td data-num="15"></td><td><pre>     默认值     <span class="token operator">=</span> isnull<span class="token punctuation">(</span>E<span class="token punctuation">.</span><span class="token keyword">Text</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token keyword">FROM</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>     syscolumns A  </pre></td></tr><tr><td data-num="18"></td><td><pre> <span class="token keyword">Left</span> <span class="token keyword">Join</span>  </pre></td></tr><tr><td data-num="19"></td><td><pre>     systypes B  </pre></td></tr><tr><td data-num="20"></td><td><pre> <span class="token keyword">On</span>  </pre></td></tr><tr><td data-num="21"></td><td><pre>     A<span class="token punctuation">.</span>xusertype<span class="token operator">=</span>B<span class="token punctuation">.</span>xusertype  </pre></td></tr><tr><td data-num="22"></td><td><pre> <span class="token keyword">Inner</span> <span class="token keyword">Join</span>  </pre></td></tr><tr><td data-num="23"></td><td><pre>     sysobjects D  </pre></td></tr><tr><td data-num="24"></td><td><pre> <span class="token keyword">On</span>  </pre></td></tr><tr><td data-num="25"></td><td><pre>     A<span class="token punctuation">.</span>id<span class="token operator">=</span>D<span class="token punctuation">.</span>id  <span class="token operator">and</span> D<span class="token punctuation">.</span>xtype<span class="token operator">=</span><span class="token string">'U'</span> <span class="token operator">and</span>  D<span class="token punctuation">.</span>name<span class="token operator">&lt;></span><span class="token string">'dtproperties'</span>  </pre></td></tr><tr><td data-num="26"></td><td><pre> <span class="token keyword">Left</span> <span class="token keyword">Join</span>  </pre></td></tr><tr><td data-num="27"></td><td><pre>     syscomments E  </pre></td></tr><tr><td data-num="28"></td><td><pre> <span class="token keyword">on</span>  </pre></td></tr><tr><td data-num="29"></td><td><pre>     A<span class="token punctuation">.</span>cdefault<span class="token operator">=</span>E<span class="token punctuation">.</span>id  </pre></td></tr><tr><td data-num="30"></td><td><pre> <span class="token keyword">Left</span> <span class="token keyword">Join</span>  </pre></td></tr><tr><td data-num="31"></td><td><pre> sys<span class="token punctuation">.</span>extended_properties  G  </pre></td></tr><tr><td data-num="32"></td><td><pre> <span class="token keyword">on</span>  </pre></td></tr><tr><td data-num="33"></td><td><pre>     A<span class="token punctuation">.</span>id<span class="token operator">=</span>G<span class="token punctuation">.</span>major_id <span class="token operator">and</span> A<span class="token punctuation">.</span>colid<span class="token operator">=</span>G<span class="token punctuation">.</span>minor_id  </pre></td></tr><tr><td data-num="34"></td><td><pre> <span class="token keyword">Left</span> <span class="token keyword">Join</span>  </pre></td></tr><tr><td data-num="35"></td><td><pre>  </pre></td></tr><tr><td data-num="36"></td><td><pre> sys<span class="token punctuation">.</span>extended_properties F  </pre></td></tr><tr><td data-num="37"></td><td><pre> <span class="token keyword">On</span>  </pre></td></tr><tr><td data-num="38"></td><td><pre>     D<span class="token punctuation">.</span>id<span class="token operator">=</span>F<span class="token punctuation">.</span>major_id <span class="token operator">and</span> F<span class="token punctuation">.</span>minor_id<span class="token operator">=</span><span class="token number">0</span>  </pre></td></tr><tr><td data-num="39"></td><td><pre>     <span class="token comment">--where d.name='OrderInfo'    -- 如果只查询指定表，加上此条件  </span></pre></td></tr><tr><td data-num="40"></td><td><pre> <span class="token keyword">Order</span> <span class="token keyword">By</span>  </pre></td></tr><tr><td data-num="41"></td><td><pre>     A<span class="token punctuation">.</span>id<span class="token punctuation">,</span>A<span class="token punctuation">.</span>colorder</pre></td></tr></table></figure><ol start="30"><li>判断是否存在数据库、表、列、视图（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">--1 判断数据库是否存在</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">if</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span><span class="token keyword">databases</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'数据库名'</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">drop</span> <span class="token keyword">database</span> <span class="token punctuation">[</span>数据库名<span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">--2 判断表是否存在</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">if</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sysobjects <span class="token keyword">where</span> id <span class="token operator">=</span> object_id<span class="token punctuation">(</span>N<span class="token string">'[表名]'</span><span class="token punctuation">)</span> <span class="token operator">and</span> OBJECTPROPERTY<span class="token punctuation">(</span>id<span class="token punctuation">,</span> N<span class="token string">'IsUserTable'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token punctuation">[</span>表名<span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">--3 判断存储过程是否存在</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">if</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sysobjects <span class="token keyword">where</span> id <span class="token operator">=</span> object_id<span class="token punctuation">(</span>N<span class="token string">'[存储过程名]'</span><span class="token punctuation">)</span> <span class="token operator">and</span> OBJECTPROPERTY<span class="token punctuation">(</span>id<span class="token punctuation">,</span> N<span class="token string">'IsProcedure'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token punctuation">[</span>存储过程名<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">--4 判断临时表是否存在</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">if</span> object_id<span class="token punctuation">(</span><span class="token string">'tempdb..#临时表名'</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>    </pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token comment">#临时表名</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">--5 判断视图是否存在 </span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">-- 判断是否存在 'MyView52' 这个试图</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> TABLE_NAME <span class="token keyword">FROM</span> INFORMATION_SCHEMA<span class="token punctuation">.</span>VIEWS <span class="token keyword">WHERE</span> TABLE_NAME <span class="token operator">=</span> N<span class="token string">'MyView52'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">PRINT</span> <span class="token string">'存在'</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">else</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">PRINT</span> <span class="token string">'不存在'</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">--6 判断函数是否存在 </span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">--  判断要创建的函数名是否存在    </span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">if</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">where</span> id <span class="token operator">=</span> object_id<span class="token punctuation">(</span>N<span class="token string">'[dbo].[函数名]'</span><span class="token punctuation">)</span> <span class="token operator">and</span> xtype <span class="token operator">in</span> <span class="token punctuation">(</span>N<span class="token string">'FN'</span><span class="token punctuation">,</span> N<span class="token string">'IF'</span><span class="token punctuation">,</span> N<span class="token string">'TF'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    </pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">drop</span> <span class="token keyword">function</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>函数名<span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">--7 获取用户创建的对象信息</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">SELECT</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span>crdate <span class="token keyword">FROM</span> sysobjects <span class="token keyword">where</span> xtype<span class="token operator">=</span><span class="token string">'U'</span> </pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">--8 判断列是否存在</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">if</span> <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> syscolumns <span class="token keyword">where</span> id<span class="token operator">=</span>object_id<span class="token punctuation">(</span><span class="token string">'表名'</span><span class="token punctuation">)</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'列名'</span><span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">alter</span> <span class="token keyword">table</span> 表名 <span class="token keyword">drop</span> <span class="token keyword">column</span> 列名</pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">--9 判断列是否自增列</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">if</span> columnproperty<span class="token punctuation">(</span>object_id<span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'col'</span><span class="token punctuation">,</span><span class="token string">'IsIdentity'</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span>  </pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">print</span> <span class="token string">'自增列'</span>  </pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token keyword">else</span>  </pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">print</span> <span class="token string">'不是自增列'</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  </pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">WHERE</span> object_id<span class="token operator">=</span>OBJECT_ID<span class="token punctuation">(</span><span class="token string">'表名'</span><span class="token punctuation">)</span>  <span class="token operator">AND</span> is_identity<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">--10 判断表中是否存在索引</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">if</span> <span class="token keyword">exists</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sysindexes <span class="token keyword">where</span> id<span class="token operator">=</span>object_id<span class="token punctuation">(</span><span class="token string">'表名'</span><span class="token punctuation">)</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'索引名'</span><span class="token punctuation">)</span>    </pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token keyword">print</span>  <span class="token string">'存在'</span>    </pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token keyword">else</span>    </pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">print</span>  <span class="token string">'不存在'</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>删除索引 <span class="token keyword">drop</span> <span class="token keyword">index</span> 表名<span class="token punctuation">.</span>索引名 </pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>        或: <span class="token keyword">drop</span> <span class="token keyword">index</span> 索引名  <span class="token keyword">on</span> 表名<span class="token punctuation">(</span>貌似<span class="token number">2000</span>不行<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token comment">--11 查看数据库中对象</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>sysobjects <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'对象名'</span>  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>sysobjects <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'对象名'</span></pre></td></tr></table></figure><ol start="31"><li>CTE 查询的存储过程执行时间明显超出 T-Sql 查询。 可以通过添加 “WITH RECOMPILE” 参数，强制存储过程每次执行时重编译，实现快速查询。 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>大神的帖子： Parameter Sniffing<span class="token punctuation">,</span> Embedding<span class="token punctuation">,</span> <span class="token operator">and</span> the RECOMPILE Options </pre></td></tr><tr><td data-num="2"></td><td><pre>https:<span class="token comment">//www.cnblogs.com/wy123/p/6262800.html</span></pre></td></tr></table></figure><ol start="32"><li>解决 insert exec 嵌套问题，解决办法是建立一个指向自己的数据库，增加链接服务器。 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">--1. 首先，增加链接服务器：</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token keyword">exec</span> sp_addlinkedserver <span class="token string">'srv1'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'SQLOLEDB'</span><span class="token punctuation">,</span><span class="token string">'(local)'</span>   </pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token keyword">exec</span> sp_addlinkedsrvlogin <span class="token string">'srv1'</span><span class="token punctuation">,</span><span class="token string">'false'</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'sa'</span><span class="token punctuation">,</span><span class="token string">'sa'</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">--2. 其次找到该链接服务器，右键属性，开启 RPC：</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>   服务器对象<span class="token operator">-</span><span class="token operator">></span>链接服务器<span class="token operator">-</span><span class="token operator">></span>右键<span class="token operator">-</span><span class="token operator">></span>属性<span class="token operator">-</span><span class="token operator">></span>服务器选项<span class="token operator">-</span><span class="token operator">></span>RPC、RPC <span class="token keyword">Out</span> 都设置为<span class="token boolean">True</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">--3. 启动 MSDTC 服务：</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  服务名称为：MSDTC（显示名称为<span class="token keyword">Distributed</span> <span class="token keyword">Transaction</span> Coordinator）</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  如果没启动会报错如下：MSDTC <span class="token keyword">on</span> server <span class="token string">'servername'</span> <span class="token operator">is</span> unavailable </pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">--4. 调整存储过程访问，使用 srv1 调用存储过程 </span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">insert</span> <span class="token comment">#Temp exec srv1.DBName.dbo.Proc_Test @param </span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">--5. 成功！结束！</span></pre></td></tr></table></figure><ol start="33"><li>查询数据库连接数、用户等（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 查看连接到数据库 "DB" 的连接</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysprocesses <span class="token keyword">WHERE</span> dbid <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span><span class="token string">'DB'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 查询某个数据库用户的连接情况</span></pre></td></tr><tr><td data-num="4"></td><td><pre>sp_who <span class="token string">'sa'</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">-- 以主机名分组显示 (与连接池配置的一样)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">select</span>   hostname 主机名<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> 连接数量  <span class="token keyword">from</span>   master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysprocesses <span class="token keyword">group</span> <span class="token keyword">by</span> hostname <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">desc</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">-- 根据主机和登陆名查看连接</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span>  master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysprocesses  <span class="token keyword">where</span> hostname <span class="token operator">=</span> <span class="token string">'hmgx'</span>  <span class="token operator">and</span> loginame <span class="token operator">=</span> <span class="token string">'abc'</span> </pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">-- 字段 Blocked&lt;>0 代表当前的 SQL Server 会话 ID 被锁定，锁定当前会话 ID 的 SQL Server 会话 ID 就是 Blocked 中的值。</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>sysprocesses <span class="token keyword">where</span> blocked <span class="token operator">&lt;></span> <span class="token number">0</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">-- 查询某个会话所执行的 SQL 语句</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">dbcc</span> inputbuffer<span class="token punctuation">(</span>spid<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">-- 查看数据库允许的最大连接</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">select</span> @<span class="token variable">@MAX_CONNECTIONS</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">-- 查看数据库自上次启动以来的连接次数</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">SELECT</span> @<span class="token variable">@CONNECTIONS</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">-- 关闭连接，上面的查询可以得到 spid，根据 spid，关闭进程就可以了。</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">kill</span> <span class="token number">54</span></pre></td></tr></table></figure><ol start="34"><li>当前正在执行的语句 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> session_id<span class="token punctuation">,</span>transaction_id<span class="token punctuation">,</span>wait_type<span class="token punctuation">,</span>last_wait_type<span class="token punctuation">,</span>wait_resource<span class="token punctuation">,</span>start_time<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>command</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">,</span>estimated_completion_time<span class="token punctuation">,</span>cpu_time<span class="token punctuation">,</span>logical_reads<span class="token punctuation">,</span><span class="token keyword">text</span><span class="token punctuation">,</span>open_transaction_count<span class="token punctuation">,</span>open_resultset_count<span class="token punctuation">,</span>percent_complete</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> sys<span class="token punctuation">.</span>dm_exec_requests r <span class="token keyword">cross</span> <span class="token keyword">apply</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>r<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> s</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">where</span> session_id<span class="token operator">></span><span class="token number">50</span> <span class="token operator">and</span> session_id<span class="token operator">&lt;></span>@<span class="token variable">@spid</span></pre></td></tr><tr><td data-num="5"></td><td><pre>go</pre></td></tr></table></figure><ol start="35"><li>堵塞语句 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 查询语句堵塞情况</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">select</span> spid<span class="token punctuation">,</span>blocked<span class="token punctuation">,</span>waittime<span class="token punctuation">,</span>lastwaittype<span class="token punctuation">,</span>waitresource<span class="token punctuation">,</span>open_tran<span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>p<span class="token punctuation">.</span>dbid<span class="token punctuation">,</span>cpu<span class="token punctuation">,</span>physical_io<span class="token punctuation">,</span>memusage<span class="token punctuation">,</span>login_time<span class="token punctuation">,</span>last_batch</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">,</span>hostname<span class="token punctuation">,</span><span class="token punctuation">[</span>program_name<span class="token punctuation">]</span><span class="token punctuation">,</span>hostprocess<span class="token punctuation">,</span>cmd<span class="token punctuation">,</span>nt_domain<span class="token punctuation">,</span>nt_username<span class="token punctuation">,</span>net_address<span class="token punctuation">,</span>net_library<span class="token punctuation">,</span>loginame<span class="token punctuation">,</span>sql_handle<span class="token punctuation">,</span><span class="token keyword">text</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysprocesses p <span class="token keyword">cross</span> <span class="token keyword">apply</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>p<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> s</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">where</span> blocked <span class="token operator">></span><span class="token number">0</span> <span class="token operator">or</span> spid <span class="token operator">in</span><span class="token punctuation">(</span><span class="token keyword">select</span> sp<span class="token punctuation">.</span>blocked <span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysprocesses sp <span class="token keyword">where</span> sp<span class="token punctuation">.</span>blocked<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>go</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">-- 查询语句堵塞情况</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">SELECT</span></pre></td></tr><tr><td data-num="11"></td><td><pre>DB_NAME<span class="token punctuation">(</span>der<span class="token punctuation">.</span><span class="token punctuation">[</span>database_id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'数据库名'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>der<span class="token punctuation">.</span><span class="token punctuation">[</span>start_time<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token string">'开始时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>dest<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token keyword">text</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token string">'sql语句'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>der<span class="token punctuation">.</span><span class="token punctuation">[</span>session_id<span class="token punctuation">]</span><span class="token punctuation">,</span>der<span class="token punctuation">.</span><span class="token punctuation">[</span>blocking_session_id<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>sp<span class="token punctuation">.</span>lastwaittype<span class="token punctuation">,</span>sp<span class="token punctuation">.</span>hostname<span class="token punctuation">,</span>sp<span class="token punctuation">.</span>program_name<span class="token punctuation">,</span>sp<span class="token punctuation">.</span>loginame<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>der<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token keyword">status</span><span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token string">'状态'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>der<span class="token punctuation">.</span><span class="token punctuation">[</span>wait_type<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token string">'等待资源类型'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>der<span class="token punctuation">.</span><span class="token punctuation">[</span>wait_time<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token string">'等待时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>der<span class="token punctuation">.</span><span class="token punctuation">[</span>wait_resource<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token string">'等待的资源'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>der<span class="token punctuation">.</span><span class="token punctuation">[</span>logical_reads<span class="token punctuation">]</span> <span class="token keyword">AS</span> <span class="token string">'逻辑读次数'</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token punctuation">[</span>dm_exec_requests<span class="token punctuation">]</span> <span class="token keyword">AS</span> der</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysprocesses <span class="token keyword">AS</span> sp <span class="token keyword">ON</span> der<span class="token punctuation">.</span>session_id<span class="token operator">=</span>sp<span class="token punctuation">.</span>spid</pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span>  sys<span class="token punctuation">.</span><span class="token punctuation">[</span>dm_exec_sql_text<span class="token punctuation">]</span><span class="token punctuation">(</span>der<span class="token punctuation">.</span><span class="token punctuation">[</span>sql_handle<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> dest</pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">--WHERE [session_id]>50 AND session_id&lt;>@@SPID</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token string">'开始时间'</span><span class="token punctuation">,</span><span class="token string">'数据库名'</span> <span class="token punctuation">,</span> der<span class="token punctuation">.</span><span class="token punctuation">[</span>session_id<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre>GO</pre></td></tr></table></figure><ol start="36"><li>是否有未提交事务（事务锁)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> spid<span class="token punctuation">,</span>blocked<span class="token punctuation">,</span>waittime<span class="token punctuation">,</span>waittype<span class="token punctuation">,</span>waitresource<span class="token punctuation">,</span>p<span class="token punctuation">.</span>dbid<span class="token punctuation">,</span>cpu<span class="token punctuation">,</span>physical_io<span class="token punctuation">,</span>memusage<span class="token punctuation">,</span>open_tran   </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>login_time<span class="token punctuation">,</span>last_batch<span class="token punctuation">,</span>hostname<span class="token punctuation">,</span>program_name<span class="token punctuation">,</span>hostprocess<span class="token punctuation">,</span>loginame<span class="token punctuation">,</span>cmd<span class="token punctuation">,</span><span class="token keyword">text</span>   </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysprocesses p <span class="token keyword">cross</span> <span class="token keyword">apply</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>p<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> s   </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">where</span> open_tran <span class="token operator">&lt;></span> <span class="token number">0</span>   </pre></td></tr><tr><td data-num="5"></td><td><pre>go</pre></td></tr></table></figure><ol start="37"><li>各数据库连接数（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> @<span class="token variable">@ServerName</span> <span class="token keyword">AS</span> server<span class="token punctuation">,</span>NAME <span class="token keyword">AS</span> dbname<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">STATUS</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> number_of_connections<span class="token punctuation">,</span>GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">timestamp</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token keyword">databases</span> sd  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>sysprocesses sp <span class="token keyword">ON</span> sd<span class="token punctuation">.</span>database_id <span class="token operator">=</span> sp<span class="token punctuation">.</span>dbid  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">WHERE</span> database_id <span class="token operator">NOT</span> <span class="token operator">BETWEEN</span> <span class="token number">1</span> <span class="token operator">AND</span> <span class="token number">4</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> NAME  </pre></td></tr><tr><td data-num="5"></td><td><pre>GO</pre></td></tr></table></figure><ol start="38"><li>死锁跟踪，启用： dbcc traceon (1222,-1)（事务锁)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> TEMPDB<span class="token punctuation">.</span><span class="token punctuation">.</span>SYSOBJECTS <span class="token keyword">WHERE</span> ID<span class="token operator">=</span>OBJECT_ID<span class="token punctuation">(</span><span class="token string">'TEMPDB..#deadlock'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">Drop</span> <span class="token keyword">TABLE</span> <span class="token comment">#deadlock</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token comment">#deadlock(LogDate DATETIME,ProcessInfo VARCHAR(20),Text VARCHAR(2000))</span></pre></td></tr><tr><td data-num="4"></td><td><pre>go</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token comment">#deadlock EXEC xp_readerrorlog 0,1,N'deadlock victim',N'','2018-03-01','2018-12-30','DESC'</span></pre></td></tr><tr><td data-num="6"></td><td><pre>go</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token string">'exec xp_readerrorlog 0,1,NULL,NULL,'''</span><span class="token operator">+</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span>LogDate<span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">''','''</span><span class="token operator">+</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span>DATEADD<span class="token punctuation">(</span>S<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>LogDate<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">''',''ASC'''</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">FROM</span> <span class="token comment">#deadlock</span></pre></td></tr><tr><td data-num="9"></td><td><pre>go</pre></td></tr></table></figure><ol start="39"><li>查看最近失败的 SqlServer 作业（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">10</span> run_date<span class="token punctuation">,</span>run_time<span class="token punctuation">,</span>run_duration<span class="token punctuation">,</span>step_name<span class="token punctuation">,</span>message</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span>  msdb<span class="token punctuation">.</span><span class="token punctuation">.</span>sysjobhistory <span class="token keyword">where</span> run_status <span class="token operator">=</span> <span class="token number">0</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> run_date <span class="token keyword">desc</span><span class="token punctuation">,</span>run_time <span class="token keyword">desc</span></pre></td></tr><tr><td data-num="4"></td><td><pre>go</pre></td></tr></table></figure><ol start="40"><li>各 DB 最近备份情况（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">10</span> run_date<span class="token punctuation">,</span>run_time<span class="token punctuation">,</span>run_duration<span class="token punctuation">,</span>step_name<span class="token punctuation">,</span>message</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span>  msdb<span class="token punctuation">.</span><span class="token punctuation">.</span>sysjobhistory <span class="token keyword">where</span> run_status <span class="token operator">=</span> <span class="token number">0</span> </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> run_date <span class="token keyword">desc</span><span class="token punctuation">,</span>run_time <span class="token keyword">desc</span></pre></td></tr><tr><td data-num="4"></td><td><pre>go</pre></td></tr></table></figure><ol start="41"><li>谁对对象进行了 DDL 操作 (exec sp_configure 'default trace enabled')（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@path</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>    </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">SELECT</span> <span class="token variable">@path</span> <span class="token operator">=</span> Substring<span class="token punctuation">(</span>PATH<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">Len</span><span class="token punctuation">(</span>PATH<span class="token punctuation">)</span> <span class="token operator">-</span> Charindex<span class="token punctuation">(</span><span class="token string">'\', Reverse(PATH))) +'</span>\log<span class="token punctuation">.</span>trc<span class="token string">'    </span></pre></td></tr><tr><td data-num="3"></td><td><pre>FROM sys.traces WHERE  id = 1    </pre></td></tr><tr><td data-num="4"></td><td><pre>SELECT DatabaseID,NTDomainName,NTUserName,HostName, ClientProcessID,ApplicationName  </pre></td></tr><tr><td data-num="5"></td><td><pre>,LoginName,StartTime,DatabaseName,ObjectName,SessionLoginName</pre></td></tr><tr><td data-num="6"></td><td><pre>,(CASE WHEN EventClass=46 THEN 'Object:Created<span class="token string">' WHEN EventClass=47 THEN '</span>Object:Deleted<span class="token string">' WHEN EventClass=164 THEN '</span>Object:Altered<span class="token string">' END)EventClass</span></pre></td></tr><tr><td data-num="7"></td><td><pre>FROM ::fn_trace_gettable(@path, 0)    </pre></td></tr><tr><td data-num="8"></td><td><pre>WHERE EventClass in(46,47,164) and DatabaseName&lt;>'tempdb' <span class="token operator">and</span> ObjectName <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>GO</pre></td></tr></table></figure><ol start="42"><li>平均耗时最大的 SQL 语句 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">30</span> execution_count<span class="token punctuation">,</span>total_worker_time<span class="token punctuation">,</span>total_logical_reads<span class="token punctuation">,</span>total_logical_writes</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">,</span>total_worker_time<span class="token operator">/</span>total_logical_reads <span class="token keyword">as</span> avgRead<span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token keyword">text</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_query_stats qs  <span class="token keyword">cross</span> <span class="token keyword">apply</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> s</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">where</span> execution_count<span class="token operator">>=</span><span class="token number">100</span> <span class="token operator">and</span> total_logical_reads<span class="token operator">&lt;></span><span class="token number">0</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> avgRead <span class="token keyword">desc</span></pre></td></tr><tr><td data-num="6"></td><td><pre>go</pre></td></tr></table></figure><ol start="43"><li>平均罗辑读最大的 SQL 语句 (性能、堵塞)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">30</span> execution_count<span class="token punctuation">,</span>total_worker_time<span class="token punctuation">,</span>total_logical_reads<span class="token punctuation">,</span>total_logical_writes</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">,</span>total_worker_time<span class="token operator">/</span>total_logical_reads <span class="token keyword">as</span> avgRead<span class="token punctuation">,</span>s<span class="token punctuation">.</span><span class="token keyword">text</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_query_stats qs <span class="token keyword">cross</span> <span class="token keyword">apply</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> s</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">where</span> execution_count<span class="token operator">&lt;=</span><span class="token number">10</span> <span class="token operator">and</span> total_logical_reads<span class="token operator">&lt;></span><span class="token number">0</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> avgRead <span class="token keyword">desc</span></pre></td></tr><tr><td data-num="6"></td><td><pre>go</pre></td></tr></table></figure><ol start="44"><li>系统主要等待类型（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">10</span>   </pre></td></tr><tr><td data-num="2"></td><td><pre>wait_type<span class="token punctuation">,</span>waiting_tasks_count <span class="token punctuation">,</span>wait_time_ms<span class="token punctuation">,</span>signal_wait_time_ms   </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">,</span>wait_time_ms <span class="token operator">-</span> signal_wait_time_ms <span class="token keyword">AS</span> resource_wait_time_ms   </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">,</span><span class="token number">100.0</span> <span class="token operator">*</span> wait_time_ms <span class="token operator">/</span> <span class="token function">SUM</span> <span class="token punctuation">(</span>wait_time_ms <span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token keyword">AS</span> percent_total_waits   </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">,</span><span class="token number">100.0</span> <span class="token operator">*</span> signal_wait_time_ms <span class="token operator">/</span> <span class="token function">SUM</span> <span class="token punctuation">(</span>signal_wait_time_ms<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token keyword">AS</span> percent_total_signal_waits   </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">,</span><span class="token number">100.0</span> <span class="token operator">*</span> <span class="token punctuation">(</span> wait_time_ms <span class="token operator">-</span> signal_wait_time_ms <span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">SUM</span> <span class="token punctuation">(</span>wait_time_ms <span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token keyword">AS</span> percent_total_resource_waits   </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">FROM</span> sys <span class="token punctuation">.</span>dm_os_wait_stats  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">WHERE</span> wait_time_ms <span class="token operator">></span> <span class="token number">0</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>go</pre></td></tr></table></figure><ol start="45"><li>当前锁请求脚本 （事务锁)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> req_spid  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">,</span><span class="token keyword">case</span> req_status <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'已授予'</span> <span class="token keyword">when</span> <span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">'正在转换'</span> <span class="token keyword">when</span> <span class="token number">3</span> <span class="token keyword">then</span> <span class="token string">'正在等待'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> req_status  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">,</span><span class="token keyword">case</span> rsc_type <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'NULL 资源（未使用）'</span> <span class="token keyword">when</span> <span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">'数据库'</span> <span class="token keyword">when</span> <span class="token number">3</span> <span class="token keyword">then</span> <span class="token string">'文件'</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">when</span> <span class="token number">4</span> <span class="token keyword">then</span> <span class="token string">'索引'</span> <span class="token keyword">when</span> <span class="token number">5</span> <span class="token keyword">then</span> <span class="token string">'表'</span> <span class="token keyword">when</span> <span class="token number">6</span> <span class="token keyword">then</span> <span class="token string">'页'</span> <span class="token keyword">when</span> <span class="token number">7</span> <span class="token keyword">then</span> <span class="token string">'键'</span>   </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">when</span> <span class="token number">8</span> <span class="token keyword">then</span> <span class="token string">'扩展盘区'</span> <span class="token keyword">when</span> <span class="token number">9</span> <span class="token keyword">then</span> <span class="token string">'RID（行 ID)'</span> <span class="token keyword">when</span> <span class="token number">10</span> <span class="token keyword">then</span> <span class="token string">'应用程序'</span> <span class="token keyword">else</span> <span class="token string">''</span> <span class="token keyword">end</span> rsc_type  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">,</span><span class="token keyword">coalesce</span><span class="token punctuation">(</span>OBJECT_NAME<span class="token punctuation">(</span>rsc_objid<span class="token punctuation">)</span><span class="token punctuation">,</span>db_name<span class="token punctuation">(</span>rsc_dbid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>object<span class="token punctuation">]</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">,</span><span class="token keyword">case</span> req_mode <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'NULL'</span> <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'Sch-S'</span> <span class="token keyword">when</span> <span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">'Sch-M'</span> <span class="token keyword">when</span> <span class="token number">3</span> <span class="token keyword">then</span> <span class="token string">'S'</span>   </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">when</span> <span class="token number">4</span> <span class="token keyword">then</span> <span class="token string">'U'</span> <span class="token keyword">when</span> <span class="token number">5</span> <span class="token keyword">then</span> <span class="token string">'X'</span> <span class="token keyword">when</span> <span class="token number">6</span> <span class="token keyword">then</span> <span class="token string">'IS'</span> <span class="token keyword">when</span> <span class="token number">7</span> <span class="token keyword">then</span> <span class="token string">'IU'</span> <span class="token keyword">when</span> <span class="token number">8</span> <span class="token keyword">then</span> <span class="token string">'IX'</span> <span class="token keyword">when</span> <span class="token number">9</span> <span class="token keyword">then</span> <span class="token string">'SIU'</span>   </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">when</span> <span class="token number">10</span> <span class="token keyword">then</span> <span class="token string">'SIX'</span> <span class="token keyword">when</span> <span class="token number">11</span> <span class="token keyword">then</span> <span class="token string">'UIX'</span> <span class="token keyword">when</span> <span class="token number">12</span> <span class="token keyword">then</span> <span class="token string">'BU'</span> <span class="token keyword">when</span> <span class="token number">13</span> <span class="token keyword">then</span> <span class="token string">'RangeS_S'</span> <span class="token keyword">when</span> <span class="token number">14</span> <span class="token keyword">then</span> <span class="token string">'RangeS_U'</span>   </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">when</span> <span class="token number">15</span> <span class="token keyword">then</span> <span class="token string">'RangeI_N'</span> <span class="token keyword">when</span> <span class="token number">16</span> <span class="token keyword">then</span> <span class="token string">'RangeI_S'</span> <span class="token keyword">when</span> <span class="token number">17</span> <span class="token keyword">then</span> <span class="token string">'RangeI_U'</span> <span class="token keyword">when</span> <span class="token number">18</span> <span class="token keyword">then</span> <span class="token string">'RangeI_X'</span>   </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">when</span> <span class="token number">19</span> <span class="token keyword">then</span> <span class="token string">'RangeX_S'</span> <span class="token keyword">when</span> <span class="token number">20</span> <span class="token keyword">then</span> <span class="token string">'RangeX_U'</span> <span class="token keyword">when</span> <span class="token number">21</span> <span class="token keyword">then</span> <span class="token string">'RangeX_X'</span> <span class="token keyword">else</span> <span class="token string">''</span> <span class="token keyword">end</span> req_mode  </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">,</span>rsc_indid <span class="token keyword">as</span> index_id<span class="token punctuation">,</span>rsc_text<span class="token punctuation">,</span>req_refcnt  </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">,</span><span class="token keyword">case</span> req_ownertype <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'事务'</span> <span class="token keyword">when</span> <span class="token number">2</span> <span class="token keyword">then</span> <span class="token string">'游标'</span> <span class="token keyword">when</span> <span class="token number">3</span> <span class="token keyword">then</span> <span class="token string">'会话'</span> <span class="token keyword">when</span> <span class="token number">4</span> <span class="token keyword">then</span> <span class="token string">'ExSession'</span> <span class="token keyword">else</span><span class="token string">''</span> <span class="token keyword">end</span> req_ownertype  </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">from</span> sys<span class="token punctuation">.</span>syslockinfo <span class="token keyword">WHERE</span> rsc_type<span class="token operator">&lt;></span><span class="token number">2</span> </pre></td></tr><tr><td data-num="15"></td><td><pre>GO</pre></td></tr></table></figure><ol start="46"><li>查看日志大小（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">EXEC</span> xp_enumerrorlogs <span class="token number">1</span> <span class="token comment">-- 查看 sqlserver 错误日志大小  </span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">EXEC</span> xp_enumerrorlogs <span class="token number">2</span> <span class="token comment">-- 查看 代理日志大小 </span></pre></td></tr><tr><td data-num="3"></td><td><pre>go</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">exec</span> msdb<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sp_cycle_errorlog			<span class="token comment">--  "Sql Server 日志" 切换  </span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">exec</span> msdb<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sp_cycle_agent_errorlog 	<span class="token comment">--  "代理错误日志" 切换  </span></pre></td></tr><tr><td data-num="6"></td><td><pre>go</pre></td></tr></table></figure><ol start="47"><li>各数据库日志大小及使用百分比（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">dbcc</span> sqlperf<span class="token punctuation">(</span>logspace<span class="token punctuation">)</span>	</pre></td></tr><tr><td data-num="2"></td><td><pre>go</pre></td></tr></table></figure><ol start="48"><li>当前 DB 虚拟日志数量 （系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">DBCC</span> loginfo  </pre></td></tr><tr><td data-num="2"></td><td><pre>go</pre></td></tr></table></figure><ol start="49"><li>数据库活动游标（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">DBCC</span> activecursors </pre></td></tr><tr><td data-num="2"></td><td><pre>go</pre></td></tr></table></figure><ol start="50"><li>查看操作系统逻辑磁盘可用空间（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">EXEC</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>xp_fixeddrives</pre></td></tr><tr><td data-num="2"></td><td><pre>go</pre></td></tr></table></figure><ol start="51"><li>数据库大小（表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> name<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>database_files <span class="token keyword">where</span> <span class="token keyword">type</span><span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">group</span> <span class="token keyword">by</span> name <span class="token keyword">order</span> <span class="token keyword">by</span> name</pre></td></tr><tr><td data-num="2"></td><td><pre>go</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">exec</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>proc_getdbspaceused</pre></td></tr><tr><td data-num="5"></td><td><pre>go</pre></td></tr></table></figure><ol start="52"><li>数据库表大小及行数（部分不算太准确，但可作为参考） （表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> OBJECT_NAME<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> tab<span class="token punctuation">,</span><span class="token keyword">rows</span><span class="token punctuation">,</span><span class="token punctuation">(</span>reserved<span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">as</span> size_MB</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">FROM</span> SYS<span class="token punctuation">.</span>sysindexes <span class="token keyword">WHERE</span> indid <span class="token operator">IN</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">and</span> id <span class="token operator">in</span><span class="token punctuation">(</span><span class="token keyword">select</span> object_id <span class="token keyword">from</span> sys<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> size_MB <span class="token keyword">desc</span></pre></td></tr><tr><td data-num="4"></td><td><pre>go</pre></td></tr></table></figure><ol start="53"><li>数据库文件默认设置情况（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> DB_NAME<span class="token punctuation">(</span>database_id<span class="token punctuation">)</span> <span class="token keyword">as</span> dbName<span class="token punctuation">,</span>file_id<span class="token punctuation">,</span><span class="token punctuation">(</span>size<span class="token operator">*</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token keyword">as</span> <span class="token punctuation">[</span>size<span class="token punctuation">(</span>mb<span class="token punctuation">)</span><span class="token punctuation">]</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">,</span><span class="token keyword">case</span> <span class="token keyword">when</span> is_percent_growth <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'10%'</span> <span class="token keyword">else</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>growth<span class="token operator">*</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'M'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> growth  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">,</span>type_desc<span class="token punctuation">,</span>physical_name   </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> sys<span class="token punctuation">.</span>master_files   </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">where</span> state <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre>go</pre></td></tr></table></figure><ol start="54"><li>各数据库 buffer pool 的分配情况 （系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span>   </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">CASE</span> database_id <span class="token keyword">WHEN</span> <span class="token number">32767</span> <span class="token keyword">THEN</span> <span class="token string">'ResourceDb'</span> <span class="token keyword">ELSE</span> db_name<span class="token punctuation">(</span>database_id<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">AS</span> Database_name  </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cached_pages_count  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">AS</span> cached_space_in_mb  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">convert</span><span class="token punctuation">(</span><span class="token keyword">bigint</span><span class="token punctuation">,</span>free_space_in_bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">AS</span> free_space_in_mb  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_os_buffer_descriptors<span class="token punctuation">(</span>nolock<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> db_name<span class="token punctuation">(</span>database_id<span class="token punctuation">)</span> <span class="token punctuation">,</span>database_id  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> cached_pages_count <span class="token keyword">DESC</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>GO</pre></td></tr></table></figure><ol start="55"><li>当前内存脏页数量及大小（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span> db_name<span class="token punctuation">(</span>database_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'Database'</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>page_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'Dirty Pages'</span>  </pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>page_id<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">AS</span> <span class="token string">'Dirty Pages(MB)'</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_os_buffer_descriptors<span class="token punctuation">(</span>nolock<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">WHERE</span> is_modified <span class="token operator">=</span><span class="token number">1</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> db_name<span class="token punctuation">(</span>database_id<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token string">'Dirty Pages'</span> <span class="token keyword">DESC</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>GO</pre></td></tr></table></figure><ol start="56"><li>缓存类型数量大小（系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> cacheobjtype <span class="token keyword">as</span> <span class="token punctuation">[</span>Cached <span class="token keyword">Type</span><span class="token punctuation">]</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>Number <span class="token keyword">of</span> Plans<span class="token punctuation">]</span>   </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">BIGINT</span><span class="token punctuation">,</span>size_in_bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token punctuation">[</span><span class="token keyword">Plan</span> Cache Size<span class="token punctuation">(</span>MB<span class="token punctuation">)</span><span class="token punctuation">]</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> sys<span class="token punctuation">.</span>dm_exec_cached_plans   </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">group</span> <span class="token keyword">by</span> cacheobjtype   </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">[</span><span class="token keyword">Plan</span> Cache Size<span class="token punctuation">(</span>MB<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">desc</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>GO</pre></td></tr></table></figure><ol start="57"><li>缓存对象数量大小 （系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> objtype <span class="token keyword">as</span> <span class="token punctuation">[</span>Cached Object <span class="token keyword">Type</span><span class="token punctuation">]</span>  </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>Number <span class="token keyword">of</span> Plans<span class="token punctuation">]</span>   </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">BIGINT</span><span class="token punctuation">,</span>size_in_bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token punctuation">[</span><span class="token keyword">Plan</span> Cache Size<span class="token punctuation">(</span>MB<span class="token punctuation">)</span><span class="token punctuation">]</span>  </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> sys<span class="token punctuation">.</span>dm_exec_cached_plans   </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">group</span> <span class="token keyword">by</span> objtype   </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">[</span><span class="token keyword">Plan</span> Cache Size<span class="token punctuation">(</span>MB<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">desc</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre>GO</pre></td></tr></table></figure><ol start="58"><li>前 N 行则表示最近的 N 分钟内 CPU 使用情况 （系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">DECLARE</span> <span class="token variable">@ts_now</span> <span class="token keyword">bigint</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> cpu_ticks<span class="token operator">/</span><span class="token punctuation">(</span>cpu_ticks<span class="token operator">/</span>ms_ticks<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_os_sys_info <span class="token keyword">WITH</span> <span class="token punctuation">(</span>NOLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="4"></td><td><pre> DATEADD<span class="token punctuation">(</span>ms<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token variable">@ts_now</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token keyword">timestamp</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>Event <span class="token keyword">Time</span><span class="token punctuation">]</span>    </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">,</span>SQLProcessUtilization <span class="token keyword">AS</span> <span class="token punctuation">[</span><span class="token keyword">SQL</span> Server Process CPU Utilization<span class="token punctuation">]</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">,</span>SystemIdle <span class="token keyword">AS</span> <span class="token punctuation">[</span>System Idle Process<span class="token punctuation">]</span>  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> SystemIdle <span class="token operator">-</span> SQLProcessUtilization<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>Other Process CPU Utilization<span class="token punctuation">]</span>  </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">FROM</span> <span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">SELECT</span> record<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">'(./Record/@id)[1]'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> record_id  </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">,</span>record<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">'(./Record/SchedulerMonitorEvent/SystemHealth/SystemIdle)[1]'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span><span class="token punctuation">[</span>SystemIdle<span class="token punctuation">]</span>  </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">,</span>record<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">'(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]'</span><span class="token punctuation">,</span><span class="token string">'int'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>SQLProcessUtilization<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">timestamp</span><span class="token punctuation">]</span>    </pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">FROM</span> <span class="token punctuation">(</span>  </pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">SELECT</span> <span class="token punctuation">[</span><span class="token keyword">timestamp</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">CONVERT</span><span class="token punctuation">(</span>xml<span class="token punctuation">,</span> record<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>record<span class="token punctuation">]</span>    </pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_os_ring_buffers <span class="token keyword">WITH</span> <span class="token punctuation">(</span>NOLOCK<span class="token punctuation">)</span>    </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">WHERE</span> ring_buffer_type <span class="token operator">=</span> N<span class="token string">'RING_BUFFER_SCHEDULER_MONITOR'</span>    </pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token operator">AND</span> record <span class="token operator">LIKE</span> N<span class="token string">'%&lt;SystemHealth>%'</span>  </pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">)</span> <span class="token keyword">AS</span> x    </pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">)</span> <span class="token keyword">AS</span> y    </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> record_id <span class="token keyword">DESC</span> <span class="token keyword">OPTION</span> <span class="token punctuation">(</span>RECOMPILE<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="20"></td><td><pre>GO</pre></td></tr></table></figure><ol start="59"><li>复制相关 （系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 事务复制：未分发命令数 (分发服务器执行)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">SELECT</span>  <span class="token string">'EXEC distribution.sys.sp_replmonitorsubscriptionpendingcmds @publisher = N'''</span>   </pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token operator">+</span> a<span class="token punctuation">.</span>publisher <span class="token operator">+</span> <span class="token string">''', @publisher_db = N'''</span> <span class="token operator">+</span> a<span class="token punctuation">.</span>publisher_db   </pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token operator">+</span> <span class="token string">''', @publication = N'''</span> <span class="token operator">+</span> a<span class="token punctuation">.</span>publication <span class="token operator">+</span> <span class="token string">''', @subscriber = N'''</span>   </pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token operator">+</span> c<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">''', @subscriber_db = N'''</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>subscriber_db   </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token operator">+</span> <span class="token string">''', @subscription_type ='</span> <span class="token operator">+</span> CAST<span class="token punctuation">(</span>b<span class="token punctuation">.</span>subscription_type <span class="token keyword">AS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">FROM</span>    distribution<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>MSreplication_monitordata a <span class="token punctuation">(</span> NOLOCK <span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>   </pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">SELECT</span>   publication_id <span class="token punctuation">,</span>subscriber_id <span class="token punctuation">,</span>subscriber_db <span class="token punctuation">,</span>subscription_type   </pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">FROM</span>     distribution<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>MSsubscriptions <span class="token punctuation">(</span>NOLOCK<span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> publication_id <span class="token punctuation">,</span>subscriber_id <span class="token punctuation">,</span>subscriber_db <span class="token punctuation">,</span>subscription_type   </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">)</span> b <span class="token keyword">ON</span> a<span class="token punctuation">.</span>publication_id <span class="token operator">=</span> b<span class="token punctuation">.</span>publication_id   </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>servers c <span class="token punctuation">(</span> NOLOCK <span class="token punctuation">)</span> <span class="token keyword">ON</span> b<span class="token punctuation">.</span>subscriber_id <span class="token operator">=</span> c<span class="token punctuation">.</span>server_id   </pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">WHERE</span>   a<span class="token punctuation">.</span>agent_type <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="15"></td><td><pre>go</pre></td></tr></table></figure><ol start="60"><li>查看前 10 个等待分发命令最多的事务数 及 查看命令 （系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">use</span> distribution </pre></td></tr><tr><td data-num="2"></td><td><pre>go </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">SELECT</span> <span class="token keyword">top</span> <span class="token number">10</span>  A<span class="token punctuation">.</span>xact_seqno<span class="token punctuation">,</span>A<span class="token punctuation">.</span>entry_time<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cmds </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">FROM</span> distribution<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>MSrepl_transactions A<span class="token punctuation">(</span>NOLOCK<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> distribution<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>MSrepl_commands B<span class="token punctuation">(</span>NOLOCK<span class="token punctuation">)</span>  </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">ON</span> A<span class="token punctuation">.</span>xact_seqno<span class="token operator">=</span>B<span class="token punctuation">.</span>xact_seqno </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> A<span class="token punctuation">.</span>xact_seqno<span class="token punctuation">,</span>A<span class="token punctuation">.</span>entry_time </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> cmds <span class="token keyword">DESC</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>go</pre></td></tr></table></figure><ol start="61"><li>查看出现错误的事务序列号 (历史记录) (分发服务器执行) （系统）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">SELECT</span>  <span class="token string">'EXEC distribution.dbo.sp_helpsubscriptionerrors N'''</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">+</span> a<span class="token punctuation">.</span>publisher <span class="token operator">+</span> <span class="token string">''', N'''</span> <span class="token operator">+</span> a<span class="token punctuation">.</span>publisher_db    <span class="token operator">+</span> <span class="token string">''', N'''</span> <span class="token operator">+</span> a<span class="token punctuation">.</span>publication <span class="token operator">+</span> <span class="token string">''', N'''</span>   <span class="token operator">+</span> c<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">''',N'''</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>subscriber_db    <span class="token operator">+</span> <span class="token string">''''</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">FROM</span>    distribution<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>MSreplication_monitordata a <span class="token punctuation">(</span> NOLOCK <span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>   </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">SELECT</span>   publication_id <span class="token punctuation">,</span>subscriber_id <span class="token punctuation">,</span>subscriber_db <span class="token punctuation">,</span>subscription_type   </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">FROM</span>     distribution<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>MSsubscriptions <span class="token punctuation">(</span>NOLOCK<span class="token punctuation">)</span>   </pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> publication_id <span class="token punctuation">,</span>subscriber_id <span class="token punctuation">,</span>subscriber_db <span class="token punctuation">,</span>subscription_type   </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">)</span> b <span class="token keyword">ON</span> a<span class="token punctuation">.</span>publication_id <span class="token operator">=</span> b<span class="token punctuation">.</span>publication_id   </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>servers c <span class="token punctuation">(</span> NOLOCK <span class="token punctuation">)</span> <span class="token keyword">ON</span> b<span class="token punctuation">.</span>subscriber_id <span class="token operator">=</span> c<span class="token punctuation">.</span>server_id   </pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">WHERE</span>   a<span class="token punctuation">.</span>agent_type <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="11"></td><td><pre>GO</pre></td></tr></table></figure><ol start="61"><li>查询字段详细信息 （表、数据库相关信息）</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">use</span> YCHMALL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">select</span> schema_name<span class="token punctuation">(</span>tab<span class="token punctuation">.</span>schema_id<span class="token punctuation">)</span> <span class="token keyword">as</span> schema_name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>       tab<span class="token punctuation">.</span>name <span class="token keyword">as</span> table_name<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>       col<span class="token punctuation">.</span>name <span class="token keyword">as</span> column_name<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>       t<span class="token punctuation">.</span>name <span class="token keyword">as</span> data_type<span class="token punctuation">,</span>    </pre></td></tr><tr><td data-num="6"></td><td><pre>       t<span class="token punctuation">.</span>name <span class="token operator">+</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>       <span class="token keyword">case</span> <span class="token keyword">when</span> t<span class="token punctuation">.</span>is_user_defined <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>                 isnull<span class="token punctuation">(</span><span class="token string">'('</span> <span class="token operator">+</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>                 <span class="token keyword">case</span> <span class="token keyword">when</span> t<span class="token punctuation">.</span>name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'binary'</span><span class="token punctuation">,</span> <span class="token string">'char'</span><span class="token punctuation">,</span> <span class="token string">'nchar'</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="10"></td><td><pre>                           <span class="token string">'varchar'</span><span class="token punctuation">,</span> <span class="token string">'nvarchar'</span><span class="token punctuation">,</span> <span class="token string">'varbinary'</span><span class="token punctuation">)</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                           <span class="token keyword">case</span> col<span class="token punctuation">.</span>max_length </pre></td></tr><tr><td data-num="12"></td><td><pre>                                <span class="token keyword">when</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'MAX'</span> </pre></td></tr><tr><td data-num="13"></td><td><pre>                                <span class="token keyword">else</span> </pre></td></tr><tr><td data-num="14"></td><td><pre>                                     <span class="token keyword">case</span> <span class="token keyword">when</span> t<span class="token punctuation">.</span>name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'nchar'</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="15"></td><td><pre>                                               <span class="token string">'nvarchar'</span><span class="token punctuation">)</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                                               cast<span class="token punctuation">(</span>col<span class="token punctuation">.</span>max_length<span class="token operator">/</span><span class="token number">2</span> </pre></td></tr><tr><td data-num="17"></td><td><pre>                                               <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="18"></td><td><pre>                                          <span class="token keyword">else</span> cast<span class="token punctuation">(</span>col<span class="token punctuation">.</span>max_length </pre></td></tr><tr><td data-num="19"></td><td><pre>                                               <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="20"></td><td><pre>                                     <span class="token keyword">end</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                           <span class="token keyword">end</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                      <span class="token keyword">when</span> t<span class="token punctuation">.</span>name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'datetime2'</span><span class="token punctuation">,</span> <span class="token string">'datetimeoffset'</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="23"></td><td><pre>                           <span class="token string">'time'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> </pre></td></tr><tr><td data-num="24"></td><td><pre>                           cast<span class="token punctuation">(</span>col<span class="token punctuation">.</span>scale <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                      <span class="token keyword">when</span> t<span class="token punctuation">.</span>name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'decimal'</span><span class="token punctuation">,</span> <span class="token string">'numeric'</span><span class="token punctuation">)</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                            cast<span class="token punctuation">(</span>col<span class="token punctuation">.</span><span class="token keyword">precision</span> <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">', '</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                            cast<span class="token punctuation">(</span>col<span class="token punctuation">.</span>scale <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                 <span class="token keyword">end</span> <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>        </pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">else</span> <span class="token string">':'</span> <span class="token operator">+</span> </pre></td></tr><tr><td data-num="30"></td><td><pre>                 <span class="token punctuation">(</span><span class="token keyword">select</span> c_t<span class="token punctuation">.</span>name <span class="token operator">+</span> </pre></td></tr><tr><td data-num="31"></td><td><pre>                         isnull<span class="token punctuation">(</span><span class="token string">'('</span> <span class="token operator">+</span> </pre></td></tr><tr><td data-num="32"></td><td><pre>                         <span class="token keyword">case</span> <span class="token keyword">when</span> c_t<span class="token punctuation">.</span>name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'binary'</span><span class="token punctuation">,</span> <span class="token string">'char'</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="33"></td><td><pre>                                   <span class="token string">'nchar'</span><span class="token punctuation">,</span> <span class="token string">'varchar'</span><span class="token punctuation">,</span> <span class="token string">'nvarchar'</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="34"></td><td><pre>                                   <span class="token string">'varbinary'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> </pre></td></tr><tr><td data-num="35"></td><td><pre>                                    <span class="token keyword">case</span> c<span class="token punctuation">.</span>max_length </pre></td></tr><tr><td data-num="36"></td><td><pre>                                         <span class="token keyword">when</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">then</span> <span class="token string">'MAX'</span> </pre></td></tr><tr><td data-num="37"></td><td><pre>                                         <span class="token keyword">else</span>   </pre></td></tr><tr><td data-num="38"></td><td><pre>                                              <span class="token keyword">case</span> <span class="token keyword">when</span> t<span class="token punctuation">.</span>name <span class="token operator">in</span> </pre></td></tr><tr><td data-num="39"></td><td><pre>                                                        <span class="token punctuation">(</span><span class="token string">'nchar'</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="40"></td><td><pre>                                                        <span class="token string">'nvarchar'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> </pre></td></tr><tr><td data-num="41"></td><td><pre>                                                        cast<span class="token punctuation">(</span>c<span class="token punctuation">.</span>max_length<span class="token operator">/</span><span class="token number">2</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                                                        <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                                                   <span class="token keyword">else</span> cast<span class="token punctuation">(</span>c<span class="token punctuation">.</span>max_length</pre></td></tr><tr><td data-num="44"></td><td><pre>                                                        <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                                              <span class="token keyword">end</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                                    <span class="token keyword">end</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                              <span class="token keyword">when</span> c_t<span class="token punctuation">.</span>name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'datetime2'</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="48"></td><td><pre>                                   <span class="token string">'datetimeoffset'</span><span class="token punctuation">,</span> <span class="token string">'time'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> </pre></td></tr><tr><td data-num="49"></td><td><pre>                                   cast<span class="token punctuation">(</span>c<span class="token punctuation">.</span>scale <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                              <span class="token keyword">when</span> c_t<span class="token punctuation">.</span>name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'decimal'</span><span class="token punctuation">,</span> <span class="token string">'numeric'</span><span class="token punctuation">)</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                                   cast<span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token keyword">precision</span> <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">', '</span> </pre></td></tr><tr><td data-num="52"></td><td><pre>                                   <span class="token operator">+</span> cast<span class="token punctuation">(</span>c<span class="token punctuation">.</span>scale <span class="token keyword">as</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                         <span class="token keyword">end</span> <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="54"></td><td><pre>                    <span class="token keyword">from</span> sys<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">as</span> c</pre></td></tr><tr><td data-num="55"></td><td><pre>                         <span class="token keyword">inner</span> <span class="token keyword">join</span> sys<span class="token punctuation">.</span><span class="token keyword">types</span> <span class="token keyword">as</span> c_t </pre></td></tr><tr><td data-num="56"></td><td><pre>                             <span class="token keyword">on</span> c<span class="token punctuation">.</span>system_type_id <span class="token operator">=</span> c_t<span class="token punctuation">.</span>user_type_id</pre></td></tr><tr><td data-num="57"></td><td><pre>                   <span class="token keyword">where</span> c<span class="token punctuation">.</span>object_id <span class="token operator">=</span> col<span class="token punctuation">.</span>object_id</pre></td></tr><tr><td data-num="58"></td><td><pre>                     <span class="token operator">and</span> c<span class="token punctuation">.</span>column_id <span class="token operator">=</span> col<span class="token punctuation">.</span>column_id</pre></td></tr><tr><td data-num="59"></td><td><pre>                     <span class="token operator">and</span> c<span class="token punctuation">.</span>user_type_id <span class="token operator">=</span> col<span class="token punctuation">.</span>user_type_id</pre></td></tr><tr><td data-num="60"></td><td><pre>                 <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">end</span> <span class="token keyword">as</span> data_type_ext<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token keyword">case</span> <span class="token keyword">when</span> col<span class="token punctuation">.</span>is_nullable <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'N'</span> </pre></td></tr><tr><td data-num="63"></td><td><pre>             <span class="token keyword">else</span> <span class="token string">'Y'</span> <span class="token keyword">end</span> <span class="token keyword">as</span> nullable<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">case</span> <span class="token keyword">when</span> def<span class="token punctuation">.</span>definition <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> def<span class="token punctuation">.</span>definition </pre></td></tr><tr><td data-num="65"></td><td><pre>             <span class="token keyword">else</span> <span class="token string">''</span> <span class="token keyword">end</span> <span class="token keyword">as</span> default_value<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token keyword">case</span> <span class="token keyword">when</span> pk<span class="token punctuation">.</span>column_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token string">'PK'</span> </pre></td></tr><tr><td data-num="67"></td><td><pre>             <span class="token keyword">else</span> <span class="token string">''</span> <span class="token keyword">end</span> <span class="token keyword">as</span> primary_key<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">case</span> <span class="token keyword">when</span> fk<span class="token punctuation">.</span>parent_column_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token string">'FK'</span> </pre></td></tr><tr><td data-num="69"></td><td><pre>             <span class="token keyword">else</span> <span class="token string">''</span> <span class="token keyword">end</span> <span class="token keyword">as</span> foreign_key<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token keyword">case</span> <span class="token keyword">when</span> uk<span class="token punctuation">.</span>column_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token string">'UK'</span> </pre></td></tr><tr><td data-num="71"></td><td><pre>             <span class="token keyword">else</span> <span class="token string">''</span> <span class="token keyword">end</span> <span class="token keyword">as</span> unique_key<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">case</span> <span class="token keyword">when</span> ch<span class="token punctuation">.</span>check_const <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> ch<span class="token punctuation">.</span>check_const </pre></td></tr><tr><td data-num="73"></td><td><pre>             <span class="token keyword">else</span> <span class="token string">''</span> <span class="token keyword">end</span> <span class="token keyword">as</span> check_contraint<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        cc<span class="token punctuation">.</span>definition <span class="token keyword">as</span> computed_column_definition<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        ep<span class="token punctuation">.</span><span class="token keyword">value</span> <span class="token keyword">as</span> comments</pre></td></tr><tr><td data-num="76"></td><td><pre>   <span class="token keyword">from</span> sys<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">as</span> tab</pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token keyword">left</span> <span class="token keyword">join</span> sys<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">as</span> col</pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token keyword">on</span> tab<span class="token punctuation">.</span>object_id <span class="token operator">=</span> col<span class="token punctuation">.</span>object_id</pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token keyword">left</span> <span class="token keyword">join</span> sys<span class="token punctuation">.</span><span class="token keyword">types</span> <span class="token keyword">as</span> t</pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token keyword">on</span> col<span class="token punctuation">.</span>user_type_id <span class="token operator">=</span> t<span class="token punctuation">.</span>user_type_id</pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token keyword">left</span> <span class="token keyword">join</span> sys<span class="token punctuation">.</span>default_constraints <span class="token keyword">as</span> def</pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token keyword">on</span> def<span class="token punctuation">.</span>object_id <span class="token operator">=</span> col<span class="token punctuation">.</span>default_object_id</pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                  <span class="token keyword">select</span> index_columns<span class="token punctuation">.</span>object_id<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="85"></td><td><pre>                         index_columns<span class="token punctuation">.</span>column_id</pre></td></tr><tr><td data-num="86"></td><td><pre>                    <span class="token keyword">from</span> sys<span class="token punctuation">.</span>index_columns</pre></td></tr><tr><td data-num="87"></td><td><pre>                         <span class="token keyword">inner</span> <span class="token keyword">join</span> sys<span class="token punctuation">.</span>indexes </pre></td></tr><tr><td data-num="88"></td><td><pre>                             <span class="token keyword">on</span> index_columns<span class="token punctuation">.</span>object_id <span class="token operator">=</span> indexes<span class="token punctuation">.</span>object_id</pre></td></tr><tr><td data-num="89"></td><td><pre>                            <span class="token operator">and</span> index_columns<span class="token punctuation">.</span>index_id <span class="token operator">=</span> indexes<span class="token punctuation">.</span>index_id</pre></td></tr><tr><td data-num="90"></td><td><pre>                   <span class="token keyword">where</span> indexes<span class="token punctuation">.</span>is_primary_key <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                  <span class="token punctuation">)</span> <span class="token keyword">as</span> pk </pre></td></tr><tr><td data-num="92"></td><td><pre>            <span class="token keyword">on</span> col<span class="token punctuation">.</span>object_id <span class="token operator">=</span> pk<span class="token punctuation">.</span>object_id </pre></td></tr><tr><td data-num="93"></td><td><pre>           <span class="token operator">and</span> col<span class="token punctuation">.</span>column_id <span class="token operator">=</span> pk<span class="token punctuation">.</span>column_id</pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                  <span class="token keyword">select</span> fc<span class="token punctuation">.</span>parent_column_id<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="96"></td><td><pre>                         fc<span class="token punctuation">.</span>parent_object_id</pre></td></tr><tr><td data-num="97"></td><td><pre>                    <span class="token keyword">from</span> sys<span class="token punctuation">.</span>foreign_keys <span class="token keyword">as</span> f </pre></td></tr><tr><td data-num="98"></td><td><pre>                         <span class="token keyword">inner</span> <span class="token keyword">join</span> sys<span class="token punctuation">.</span>foreign_key_columns <span class="token keyword">as</span> fc </pre></td></tr><tr><td data-num="99"></td><td><pre>                             <span class="token keyword">on</span> f<span class="token punctuation">.</span>object_id <span class="token operator">=</span> fc<span class="token punctuation">.</span>constraint_object_id</pre></td></tr><tr><td data-num="100"></td><td><pre>                   <span class="token keyword">group</span> <span class="token keyword">by</span> fc<span class="token punctuation">.</span>parent_column_id<span class="token punctuation">,</span> fc<span class="token punctuation">.</span>parent_object_id</pre></td></tr><tr><td data-num="101"></td><td><pre>                  <span class="token punctuation">)</span> <span class="token keyword">as</span> fk</pre></td></tr><tr><td data-num="102"></td><td><pre>            <span class="token keyword">on</span> fk<span class="token punctuation">.</span>parent_object_id <span class="token operator">=</span> col<span class="token punctuation">.</span>object_id </pre></td></tr><tr><td data-num="103"></td><td><pre>           <span class="token operator">and</span> fk<span class="token punctuation">.</span>parent_column_id <span class="token operator">=</span> col<span class="token punctuation">.</span>column_id    </pre></td></tr><tr><td data-num="104"></td><td><pre>        <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                  <span class="token keyword">select</span> c<span class="token punctuation">.</span>parent_column_id<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="106"></td><td><pre>                         c<span class="token punctuation">.</span>parent_object_id<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="107"></td><td><pre>                         <span class="token string">'Check'</span> check_const</pre></td></tr><tr><td data-num="108"></td><td><pre>                    <span class="token keyword">from</span> sys<span class="token punctuation">.</span>check_constraints <span class="token keyword">as</span> c</pre></td></tr><tr><td data-num="109"></td><td><pre>                   <span class="token keyword">group</span> <span class="token keyword">by</span> c<span class="token punctuation">.</span>parent_column_id<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="110"></td><td><pre>                         c<span class="token punctuation">.</span>parent_object_id</pre></td></tr><tr><td data-num="111"></td><td><pre>                  <span class="token punctuation">)</span> <span class="token keyword">as</span> ch</pre></td></tr><tr><td data-num="112"></td><td><pre>            <span class="token keyword">on</span> col<span class="token punctuation">.</span>column_id <span class="token operator">=</span> ch<span class="token punctuation">.</span>parent_column_id</pre></td></tr><tr><td data-num="113"></td><td><pre>           <span class="token operator">and</span> col<span class="token punctuation">.</span>object_id <span class="token operator">=</span> ch<span class="token punctuation">.</span>parent_object_id</pre></td></tr><tr><td data-num="114"></td><td><pre>        <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="115"></td><td><pre>                  <span class="token keyword">select</span> index_columns<span class="token punctuation">.</span>object_id<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="116"></td><td><pre>                         index_columns<span class="token punctuation">.</span>column_id</pre></td></tr><tr><td data-num="117"></td><td><pre>                    <span class="token keyword">from</span> sys<span class="token punctuation">.</span>index_columns</pre></td></tr><tr><td data-num="118"></td><td><pre>                         <span class="token keyword">inner</span> <span class="token keyword">join</span> sys<span class="token punctuation">.</span>indexes </pre></td></tr><tr><td data-num="119"></td><td><pre>                             <span class="token keyword">on</span> indexes<span class="token punctuation">.</span>index_id <span class="token operator">=</span> index_columns<span class="token punctuation">.</span>index_id</pre></td></tr><tr><td data-num="120"></td><td><pre>                            <span class="token operator">and</span> indexes<span class="token punctuation">.</span>object_id <span class="token operator">=</span> index_columns<span class="token punctuation">.</span>object_id</pre></td></tr><tr><td data-num="121"></td><td><pre>                    <span class="token keyword">where</span> indexes<span class="token punctuation">.</span>is_unique_constraint <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="122"></td><td><pre>                    <span class="token keyword">group</span> <span class="token keyword">by</span> index_columns<span class="token punctuation">.</span>object_id<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="123"></td><td><pre>                          index_columns<span class="token punctuation">.</span>column_id</pre></td></tr><tr><td data-num="124"></td><td><pre>                  <span class="token punctuation">)</span> <span class="token keyword">as</span> uk</pre></td></tr><tr><td data-num="125"></td><td><pre>            <span class="token keyword">on</span> col<span class="token punctuation">.</span>column_id <span class="token operator">=</span> uk<span class="token punctuation">.</span>column_id </pre></td></tr><tr><td data-num="126"></td><td><pre>           <span class="token operator">and</span> col<span class="token punctuation">.</span>object_id <span class="token operator">=</span> uk<span class="token punctuation">.</span>object_id</pre></td></tr><tr><td data-num="127"></td><td><pre>        <span class="token keyword">left</span> <span class="token keyword">join</span> sys<span class="token punctuation">.</span>extended_properties <span class="token keyword">as</span> ep </pre></td></tr><tr><td data-num="128"></td><td><pre>            <span class="token keyword">on</span> tab<span class="token punctuation">.</span>object_id <span class="token operator">=</span> ep<span class="token punctuation">.</span>major_id</pre></td></tr><tr><td data-num="129"></td><td><pre>           <span class="token operator">and</span> col<span class="token punctuation">.</span>column_id <span class="token operator">=</span> ep<span class="token punctuation">.</span>minor_id</pre></td></tr><tr><td data-num="130"></td><td><pre>           <span class="token operator">and</span> ep<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'MS_Description'</span></pre></td></tr><tr><td data-num="131"></td><td><pre>           <span class="token operator">and</span> ep<span class="token punctuation">.</span>class_desc <span class="token operator">=</span> <span class="token string">'OBJECT_OR_COLUMN'</span></pre></td></tr><tr><td data-num="132"></td><td><pre>        <span class="token keyword">left</span> <span class="token keyword">join</span> sys<span class="token punctuation">.</span>computed_columns <span class="token keyword">as</span> cc</pre></td></tr><tr><td data-num="133"></td><td><pre>            <span class="token keyword">on</span> tab<span class="token punctuation">.</span>object_id <span class="token operator">=</span> cc<span class="token punctuation">.</span>object_id</pre></td></tr><tr><td data-num="134"></td><td><pre>           <span class="token operator">and</span> col<span class="token punctuation">.</span>column_id <span class="token operator">=</span> cc<span class="token punctuation">.</span>column_id</pre></td></tr><tr><td data-num="135"></td><td><pre>  <span class="token keyword">order</span> <span class="token keyword">by</span> schema_name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="136"></td><td><pre>        table_name<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="137"></td><td><pre>        column_name<span class="token punctuation">;</span></pre></td></tr></table></figure><ol start="62"><li>跨数据库 linked (远程)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 服务器相关</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">print</span> <span class="token string">'服务器的名称：'</span><span class="token operator">+</span>@<span class="token variable">@SERVERNAME</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">print</span> <span class="token string">'SQL Server的版本'</span> <span class="token operator">+</span> @<span class="token variable">@VERSION</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">SELECT</span> @<span class="token variable">@SERVERNAME</span> <span class="token keyword">as</span> <span class="token string">'服务器名称'</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">select</span> @<span class="token variable">@VERSION</span> <span class="token keyword">as</span> <span class="token string">'SQL Server的版本'</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>数据库跨服务器设置：</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">EXEC</span>  sp_addlinkedserver</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token variable">@server</span><span class="token operator">=</span><span class="token string">'DEV-W2K12-114'</span><span class="token punctuation">,</span>   <span class="token comment">-- 链接服务器别名</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token variable">@srvproduct</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token variable">@provider</span><span class="token operator">=</span><span class="token string">'SQLOLEDB'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token variable">@datasrc</span><span class="token operator">=</span><span class="token string">'10.199.206.43'</span>  <span class="token comment">-- 要访问的的数据库所在的服务器的 ip</span></pre></td></tr><tr><td data-num="14"></td><td><pre>GO</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token operator">/</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">EXEC</span> sp_addlinkedsrvlogin</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token string">'dblink_43'</span><span class="token punctuation">,</span>                  <span class="token comment">-- 链接服务器别名</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token string">'false'</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="19"></td><td><pre> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token string">'Youcaihua'</span><span class="token punctuation">,</span>                     <span class="token comment">-- 要访问的数据库的用户              </span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token string">'DF170D23-9946-4340-BBCF-2A37845E8DD9'</span>                    <span class="token comment">-- 要访问的数据库，用户的密码</span></pre></td></tr><tr><td data-num="22"></td><td><pre>GO</pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">exec</span> sp_dropserver<span class="token string">'DEV-W2K12-114'</span> <span class="token punctuation">,</span><span class="token string">'droplogins'</span></pre></td></tr></table></figure><ol start="63"><li>查询历史执行的语句 (表、数据库相关信息)</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 查询历史执行的语句</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">SELECT</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>    dest<span class="token punctuation">.</span><span class="token keyword">text</span> <span class="token keyword">AS</span> QueryText<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    deqs<span class="token punctuation">.</span>creation_time<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    deqs<span class="token punctuation">.</span>execution_count</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_query_stats <span class="token keyword">AS</span> deqs</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>deqs<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> <span class="token keyword">AS</span> dest</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">WHERE</span> dest<span class="token punctuation">.</span><span class="token keyword">text</span> <span class="token operator">LIKE</span> <span class="token string">'%key_value%'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> deqs<span class="token punctuation">.</span>creation_time <span class="token keyword">desc</span></pre></td></tr></table></figure><ol start="64"><li>数据太大 使用 cmd 命令的方式导入数据</li></ol><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>osql <span class="token parameter variable">-S</span> <span class="token number">127.0</span>.0.1,1433 <span class="token parameter variable">-U</span> sa <span class="token parameter variable">-P</span> <span class="token number">123456</span> <span class="token parameter variable">-i</span> 文件路径</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>osql <span class="token parameter variable">-S</span> <span class="token number">127.0</span>.0.1,1433 <span class="token parameter variable">-U</span> sa <span class="token parameter variable">-d</span> zcjy_to_server_gzs <span class="token parameter variable">-P</span> <span class="token number">123456</span> <span class="token parameter variable">-i</span> 文件路径</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>osql ？  命令可查询相关参数</pre></td></tr></table></figure><ol start="65"><li>查看某个字段的长度</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre>datalenth<span class="token punctuation">(</span>field<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">select</span> a<span class="token punctuation">,</span> datalenth<span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token keyword">table</span></pre></td></tr></table></figure><h2 id="sqlserver安装"><a class="anchor" href="#sqlserver安装">#</a> sqlserver 安装</h2><p>请看其他专栏</p><h2 id="总结"><a class="anchor" href="#总结">#</a> 总结</h2><p>主要记录了工作中经常用到的问题排查和优化的 sql 语句</p><h2 id="参考资料"><a class="anchor" href="#参考资料">#</a> 参考资料</h2><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuYmFpZHUuY29tLw==">感谢想要的都有</span></li></ul><div class="tags"><a href="/tzblog/tags/sqlserver/" rel="tag"><i class="ic i-tag"></i> sqlserver</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-04-23 00:44:24" itemprop="dateModified" datetime="2024-04-23T00:44:24+08:00">2024-04-23</time> </span><span id="2024/03/24/computer-science/databases/sqlserver/" class="item leancloud_visitors" data-flag-title="sqlserver数据库" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/tzblog/images/wechatpay.png" alt="Tz 微信支付"><p>微信支付</p></div><div><img data-src="/tzblog/images/alipay.png" alt="Tz 支付宝"><p>支付宝</p></div><div><img data-src="/tzblog/images/paypal.png" alt="Tz 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Tz <i class="ic i-at"><em>@</em></i>一些记录</li><li class="link"><strong>本文链接：</strong> <a href="https://mytingting.gitee.io/tzblog/2024/03/24/computer-science/databases/sqlserver/" title="sqlserver数据库">https://mytingting.gitee.io/tzblog/2024/03/24/computer-science/databases/sqlserver/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/tzblog/2024/03/21/computer-science/system/windows/windows/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tzting.github.io&#x2F;images&#x2F;sky5.jpg" title="window 使用"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 系统</span><h3>window 使用</h3></a></div><div class="item right"><a href="/tzblog/2024/03/24/computer-science/databases/starrocks/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tzting.github.io&#x2F;images&#x2F;sky4.jpg" title="StarRocks数据库"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 数据库</span><h3>StarRocks数据库</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#sqlserver%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">sqlserver 数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sqlserver%E5%B8%B8%E7%94%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">1.2.</span> <span class="toc-text">sqlserver 常用脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sqlserver%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.</span> <span class="toc-text">sqlserver 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">1.5.</span> <span class="toc-text">参考资料</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/tzblog/2024/03/24/computer-science/databases/mysql/" rel="bookmark" title="mysql数据库">mysql数据库</a></li><li><a href="/tzblog/2024/03/24/computer-science/databases/dm/" rel="bookmark" title="达梦数据库">达梦数据库</a></li><li><a href="/tzblog/2024/03/24/computer-science/databases/starrocks/" rel="bookmark" title="StarRocks数据库">StarRocks数据库</a></li><li class="active"><a href="/tzblog/2024/03/24/computer-science/databases/sqlserver/" rel="bookmark" title="sqlserver数据库">sqlserver数据库</a></li><li><a href="/tzblog/2024/04/20/computer-science/databases/sql-optimization/" rel="bookmark" title="通用sql优化">通用sql优化</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Tz" data-src="/tzblog/images/avatar.jpg"><p class="name" itemprop="name">Tz</p><div class="description" itemprop="description">君将自由, 我心亦然</div></div><nav class="state"><div class="item posts"><a href="/tzblog/archives/"><span class="count">34</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/tzblog/categories/"><span class="count">18</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tzblog/tags/"><span class="count">22</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1R6VGluZw==" title="https:&#x2F;&#x2F;github.com&#x2F;TzTing"><i class="ic i-github"></i></span> <a href="/tzblog/2269472297@qq.com" title="2269472297@qq.com" class="item email"><i class="ic i-envelope"></i></a></div><ul class="menu"><li class="item"><a href="/tzblog/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/tzblog/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/tzblog/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/tzblog/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tzblog/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/tzblog/links/" rel="section"><i class="ic i-magic"></i>链接</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/tzblog/2024/03/21/computer-science/system/windows/windows/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/tzblog/2024/03/24/computer-science/databases/starrocks/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/tzblog/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/%E7%B3%BB%E7%BB%9F/" title="分类于 系统">系统</a></div><span><a href="/tzblog/2024/03/21/computer-science/system/windows/windows/" title="window 使用">window 使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/tzblog/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/xxx/" title="分类于 xxx">xxx</a></div><span><a href="/tzblog/2024/03/24/example/" title="xxx">xxx</a></span></li><li class="item"><div class="breadcrumb"><a href="/tzblog/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/%E7%B3%BB%E7%BB%9F/" title="分类于 系统">系统</a></div><span><a href="/tzblog/2024/03/21/computer-science/system/linux/Linux/" title="Linux 使用">Linux 使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/tzblog/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/framework/" title="分类于 框架">框架</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/framework/big-data-processing/" title="分类于 大数据处理框架">大数据处理框架</a></div><span><a href="/tzblog/2024/03/24/computer-science/framework/big-data-processing/dinky-1/" title="dinky">dinky</a></span></li><li class="item"><div class="breadcrumb"><a href="/tzblog/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/databases/" title="分类于 数据库">数据库</a></div><span><a href="/tzblog/2024/04/20/computer-science/databases/sql-optimization/" title="通用sql优化">通用sql优化</a></span></li><li class="item"><div class="breadcrumb"><a href="/tzblog/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/dsa/" title="分类于 数据结构与算法">数据结构与算法</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/dsa/topic/" title="分类于 每日一题">每日一题</a></div><span><a href="/tzblog/2024/03/19/computer-science/dsa/topic/1716/" title="每日一题-计算力扣银行的钱">每日一题-计算力扣银行的钱</a></span></li><li class="item"><div class="breadcrumb"><a href="/tzblog/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/tzblog/2024/04/18/computer-science/eight-part-essay/eight-part-essay/" title="八股文大全">八股文大全</a></span></li><li class="item"><div class="breadcrumb"><a href="/tzblog/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/middleware/" title="分类于 中间件">中间件</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/middleware/message-queue/" title="分类于 消息队列">消息队列</a></div><span><a href="/tzblog/2024/03/24/computer-science/middleware/message-queue/kafkamq-1/" title="kafka消息队列">kafka消息队列</a></span></li><li class="item"><div class="breadcrumb"><a href="/tzblog/categories/computer-science/" title="分类于 计算机科学">计算机科学</a></div><span><a href="/tzblog/2024/03/18/computer-science/problem/problem_count/" title="工作问题解决方案汇总">工作问题解决方案汇总</a></span></li><li class="item"><div class="breadcrumb"><a href="/tzblog/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/tzblog/categories/computer-science/dsa/" title="分类于 数据结构与算法">数据结构与算法</a></div><span><a href="/tzblog/2023/06/24/computer-science/dsa/week-1/" title="数据结构">数据结构</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Tz @ Tz</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">184k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">2:48</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/03/24/computer-science/databases/sqlserver/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/tzblog/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->